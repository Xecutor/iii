!function(t){var e={};function i(s){if(e[s])return e[s].exports;var r=e[s]={i:s,l:!1,exports:{}};return t[s].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)i.d(s,r,function(e){return t[e]}.bind(null,r));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=24)}([function(t,e,i){"use strict";const s=2.3283064365386963e-10;class r{constructor(){this._seed=0,this._s0=0,this._s1=0,this._s2=0,this._c=0}getSeed(){return this._seed}setSeed(t){return t=t<1?1/t:t,this._seed=t,this._s0=(t>>>0)*s,t=69069*t+1>>>0,this._s1=t*s,t=69069*t+1>>>0,this._s2=t*s,this._c=1,this}getUniform(){let t=2091639*this._s0+this._c*s;return this._s0=this._s1,this._s1=this._s2,this._c=0|t,this._s2=t-this._c,this._s2}getUniformInt(t,e){let i=Math.max(t,e),s=Math.min(t,e);return Math.floor(this.getUniform()*(i-s+1))+s}getNormal(t=0,e=1){let i,s,r;do{r=(i=2*this.getUniform()-1)*i+(s=2*this.getUniform()-1)*s}while(r>1||0==r);return t+i*Math.sqrt(-2*Math.log(r)/r)*e}getPercentage(){return 1+Math.floor(100*this.getUniform())}getItem(t){return t.length?t[Math.floor(this.getUniform()*t.length)]:null}shuffle(t){let e=[],i=t.slice();for(;i.length;){let t=i.indexOf(this.getItem(i));e.push(i.splice(t,1)[0])}return e}getWeightedValue(t){let e=0;for(let i in t)e+=t[i];let i,s=this.getUniform()*e,r=0;for(i in t)if(s<(r+=t[i]))return i;return i}getState(){return[this._s0,this._s1,this._s2,this._c]}setState(t){return this._s0=t[0],this._s1=t[1],this._s2=t[2],this._c=t[3],this}clone(){return(new r).setState(this.getState())}}e.a=(new r).setSeed(Date.now())},function(t,e,i){"use strict";var s;Object.defineProperty(e,"__esModule",{value:!0}),e.dirX=[0,0,-1,1],e.dirY=[-1,1,0,0],function(t){t[t.t=0]="t",t[t.b=1]="b",t[t.l=2]="l",t[t.r=3]="r"}(s=e.DIR||(e.DIR={})),e.dirCw=[s.r,s.l,s.t,s.b],e.dirCcw=[s.l,s.r,s.b,s.t],e.dirArray=[s.t,s.b,s.l,s.r],e.inverseDir=[s.b,s.t,s.r,s.l];class r{constructor(t,e){this.x=0,this.y=0,"number"==typeof t?(this.x=t,this.y=e):t instanceof r&&(this.x=t.x,this.y=t.y)}assign(t,e){return t instanceof r?(this.x=t.x,this.y=t.y):(this.x=t,this.y=e),this}add(t,e){return"number"==typeof t?(this.x+=t,this.y+=e):(this.x+=t.x,this.y+=t.y),this}addDir(t){return this.x+=e.dirX[t],this.y+=e.dirY[t],this}sub(t,e){return"number"==typeof t?(this.x-=t,this.y-=e):(this.x-=t.x,this.y-=t.y),this}mul(t){return this.x*=t,this.y*=t,this}div(t){return this.x/=t,this.y/=t,this}clone(){return new r(this.x,this.y)}clamp(t){return this.x<t.pos.x&&(this.x=t.pos.x),this.x>t.pos.x+t.size.width&&(this.x=t.pos.x+t.size.width),this.y<t.pos.y&&(this.y=t.pos.y),this.y>t.pos.y+t.size.height&&(this.y=t.pos.y+t.size.height),this}toSize(){return new n(this.x,this.y)}isEqual(t){return this.x==t.x&&this.y==t.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}makeRectAround(t){return new l(this.x-t,this.y-t,2*t,2*t)}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}id(){return`${this.x}:${this.y}`}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}}function o(t,e,i,r){return t==i?e<r?s.b:s.t:t<i?s.r:s.l}e.Pos=r,e.diffToDir=o,e.pdiffToDir=function(t,e){return o(t.x,t.y,e.x,e.y)};class n{constructor(t,e){this.width=0,this.height=0,"number"==typeof t&&(this.width=t,this.height=e)}assign(t){this.width=t.width,this.height=t.height}clone(){return new n(this.width,this.height)}toPos(){return new r(this.width,this.height)}}e.Size=n;class h{constructor(t){this.value=null,this.rect=t}next(){if(this.value){let t=this.rect.pos.y+this.rect.size.height;return!(this.value.y>=t)&&(this.value.x+=1,this.value.x>=this.rect.pos.x+this.rect.size.width&&(this.value.x=this.rect.pos.x,this.value.y+=1),this.value.y<t)}return this.value=this.rect.pos.clone(),!0}}e.RectIterator=h;class l{constructor(t,e,i,s){if(this.pos=new r,this.size=new n,"number"==typeof t&&"number"==typeof e){let r=t,o=e;this.pos.x=r,this.pos.y=o,this.size.width=i,this.size.height=s}else"object"==typeof t&&"object"==typeof e&&(this.pos=t,this.size=e)}isInside(t){return t.x>=this.pos.x&&t.y>=this.pos.y&&t.x<this.pos.x+this.size.width&&t.y<this.pos.y+this.size.height}isStrictlyInside(t){return t.x>this.pos.x&&t.y>this.pos.y&&t.x<this.pos.x+this.size.width-1&&t.y<this.pos.y+this.size.height-1}clone(){return new l(this.pos.clone(),this.size.clone())}middle(){return new r(this.pos.x+this.size.width/2,this.pos.y+this.size.height/2)}setTopLeft(t){this.size.width+=this.pos.x-t.x,this.size.height+=this.pos.y-t.y,this.pos.assign(t)}bottomRight(t){return t&&(this.size.width=t.x-this.pos.x,this.size.height=t.y-this.pos.y),this.pos.clone().add(this.size.width,this.size.height)}getIterator(){return new h(this)}sideMiddle(t){switch(t){case s.t:return new r(this.pos.x+this.size.width/2,this.pos.y);case s.b:return new r(this.pos.x+this.size.width/2,this.pos.y+this.size.height);case s.l:return new r(this.pos.x,this.pos.y+this.size.height/2);case s.r:return new r(this.pos.x+this.size.width,this.pos.y+ +this.size.height/2)}}}e.Rect=l,e.randomFromArray=function(t){return t[Math.random()*t.length|0]},e.weightedRandomFromArray=function(t,e){let i=0;for(let s of t)i+=e(s);let s=Math.random()*i,r=0;for(let i of t)if((r+=e(i))>=s)return i;return t[0]}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(1);let r=document.createElement("canvas");function o(){let t=document.body.getBoundingClientRect().width,e=document.body.getBoundingClientRect().height,i=Math.min(t/r.width,e/r.height);r.style.transform=`scale(${i})`}r.id="canvas",r.width=1920,r.height=1080,document.body.appendChild(r),window.addEventListener("resize",o),setTimeout(o,1);let n,h=r.getContext("2d");function l(t){n=t,h.font=t+"pt courier"}function a(t,e,i,s,r,o){h.shadowBlur=o,h.shadowColor=r,h.shadowOffsetX=0,h.shadowOffsetY=0,h.textAlign="left",h.textBaseline="top",h.fillStyle=i;let l=s.split("\n");for(let i of l)h.fillText(i,t,e-n/8),e+=n}l(32),e.getCtx=function(){return h},e.getBoundingRect=function(){return r.getBoundingClientRect()},e.getAppSize=function(){return new s.Size(r.width,r.height)},e.getAppRect=function(){return new s.Rect(0,0,r.width,r.height)},e.setBg=function(t){h.fillStyle=t},e.clear=function(){h.fillStyle="black",h.fillRect(0,0,r.width,r.height)},e.setClip=function(t){h.save();let e=new Path2D;e.rect(t.pos.x,t.pos.y,t.size.width,t.size.height),h.clip(e)},e.resetClip=function(){h.restore()},e.fillrect=function(t,e){h.fillStyle=e,h.fillRect(t.pos.x,t.pos.y,t.size.width,t.size.height)},e.rect=function(t,e,i,s){h.beginPath(),h.strokeStyle=e,i&&(h.lineWidth=i),"number"==typeof s&&(h.shadowBlur=s,h.shadowColor=e,h.shadowOffsetX=0,h.shadowOffsetY=0),h.rect(t.pos.x,t.pos.y,t.size.width,t.size.height),h.stroke(),"number"==typeof s&&(h.shadowBlur=0)},e.line=function(t,e,i,s=1){h.lineWidth=s,h.strokeStyle=i,h.beginPath(),h.moveTo(t.x,t.y),h.lineTo(e.x,e.y),h.stroke()},e.setFontSize=l,e.textout=function(t,e,i,s){a(t,e,i,s,"",0)},e.textoutex=a,e.getTextSize=function(t){let e=t.split("\n"),i=h.measureText(e[0]).width;for(let t=1;t<e.length;++t){let s=h.measureText(e[t]).width;s>i&&(i=s)}return new s.Size(i,n*e.length)},e.getTextHeight=function(){return n}},function(t,e,i){"use strict";function s(t,e){return(t%e+e)%e}function r(t,e=0,i=1){return t<e?e:t>i?i:t}function o(t){return t.charAt(0).toUpperCase()+t.substring(1)}function n(t,...e){let i=n.map;return t.replace(/%(?:([a-z]+)|(?:{([^}]+)}))/gi,function(s,r,n,h){if("%"==t.charAt(h-1))return s.substring(1);if(!e.length)return s;let l=e[0],a=(r||n).split(","),c=a.shift()||"",u=i[c.toLowerCase()];if(!u)return s;let d=(l=e.shift())[u].apply(l,a),p=c.charAt(0);return p!=p.toLowerCase()&&(d=o(d)),d})}i.r(e),i.d(e,"mod",function(){return s}),i.d(e,"clamp",function(){return r}),i.d(e,"capitalize",function(){return o}),i.d(e,"format",function(){return n}),n.map={s:"toString"}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(8),r=i(6),o=i(2);e.uiManager=new class extends r.UIContainer{constructor(){super(),this.animations=[];var t=document.getElementById("canvas");t.onmousedown=(t=>this.postRawMouseEvent("onMouseDown",t)),t.onmouseup=(t=>this.postRawMouseEvent("onMouseUp",t)),t.onmousemove=(t=>this.postRawMouseEvent("onMouseMove",t)),t.oncontextmenu=(t=>(t.preventDefault(),!1)),this.timerId=setInterval(()=>this.draw(),40)}postRawMouseEvent(t,e){let i=o.getBoundingRect(),r=o.getAppSize(),n=(e.clientX-i.left)*r.width/i.width,h=(e.clientY-i.top)*r.height/i.height,l=new s.MyMouseEvent(n,h,e);return this.postMouseEvent(t,l),!1}draw(){o.clear(),this.animations=this.animations.filter(t=>t.nextFrame()),super.draw()}addAnimation(t){this.animations.push(t)}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(2),o=i(17);e.tileSize=32;const n=1,h=4;e.tileFullSize=e.tileSize+2*(n+h);const l=2048,a=2048;var c;function u(t){return Math.cos(t*Math.PI)}function d(t){return Math.sin(t*Math.PI)}!function(t){t[t.begin=0]="begin",t[t.lineWidth=1]="lineWidth",t[t.line=2]="line",t[t.arc=3]="arc",t[t.stroke=4]="stroke"}(c||(c={}));class p{constructor(){this.outerRect=new s.Rect(0,0,e.tileFullSize,e.tileFullSize),this.innerRect=new s.Rect(0,0,e.tileSize,e.tileSize)}setInfo(t){this.innerRect.pos.assign(t),this.outerRect.pos.assign(t).sub(n+h,n+h)}}class f{constructor(){this.frames=new Array}addFrame(t){let e=new p;e.setInfo(t),this.frames.push(e)}}function g(t,e,i,s,r){for(let o=s;o<=r;o+=.1)t.push(o),t.push(.25+(Math.sin((o+2*i/25)*Math.PI)+1)/4),e.push(o),e.push(.25+(Math.cos((o+.5+2*i/25)*Math.PI)+1)/4)}function _(t,e,i,s,r){for(let o=s;o<=r;o+=.05)t.push(.25+(Math.sin((o+2*i/25)*Math.PI)+1)/4),t.push(o),e.push(.25+(Math.cos((o+.5+2*i/25)*Math.PI)+1)/4),e.push(o)}function m(t,e){for(let i=0;i<16;++i){let s=(e+25*i/16)%25/25*.25,r=s+.1;r>.25&&(r=.25);let o=Math.cos(i*Math.PI/8),n=Math.sin(i*Math.PI/8);const h=.5,l=.5;t.push([c.line,h+s*o,l+s*n,h+r*o,l+r*n])}}function y(t,e=1){let i=t.length,s=(i-e)/2;for(let r=0;r<s;r+=2){let s=t[e+r],o=t[e+r+1];t[e+r]=t[i-r-2],t[e+r+1]=t[i-r-1],t[i-r-2]=s,t[i-r-1]=o}}class b{constructor(){this.cacheCanvas=document.createElement("canvas"),this.cache={},this.cacheLastIdx=0,this.prepare()}getNextCachePos(){let t=this.cacheLastIdx++;const i=l/e.tileFullSize|0;let r=(t/i|0)*e.tileFullSize,o=t%i*e.tileFullSize;return this.lastPos=new s.Pos(o+n+h,r+n+h),this.lastPos}getCacheRecord(t){if(t in this.cache)return this.cache[t];{let e=new f;return this.cache[t]=e,e}}drawPrimitive(t){switch(t[0]){case c.begin:this.ctx.beginPath();break;case c.lineWidth:this.ctx.lineWidth=t[1];break;case c.line:{let i=this.lastPos.x+t[1]*e.tileSize,s=this.lastPos.y+t[2]*e.tileSize;this.ctx.moveTo(i,s);for(let i=3;i<t.length;i+=2){let s=this.lastPos.x+t[i]*e.tileSize,r=this.lastPos.y+t[i+1]*e.tileSize;this.ctx.lineTo(s,r)}}break;case c.arc:{let i=this.lastPos.x+t[1]*e.tileSize,s=this.lastPos.y+t[2]*e.tileSize,r=t[3]*e.tileSize,o=t[4]*Math.PI,n=t[5]*Math.PI,h=!!t[6];this.ctx.arc(i,s,r,o,n,h)}case c.stroke:this.ctx.stroke()}}drawFigure(t,e,i=!0){for(let s of t)for(let t=0;t<e;++t)i&&this.drawPrimitive([c.begin]),this.drawPrimitive(s),i&&this.drawPrimitive([c.stroke])}prepare(){this.cacheCanvas.width=l,this.cacheCanvas.height=a,this.ctx=this.cacheCanvas.getContext("2d");let t=this.ctx;t.fillStyle="rgba(255,255,255,0.2)";let i=this.getCacheRecord("tile-highlight"),s=this.getNextCachePos();i.addFrame(s),t.fillRect(s.x,s.y,e.tileSize,e.tileSize),t.lineWidth=2,t.shadowBlur=n,this.genPlayer(),t.shadowColor="cyan",t.strokeStyle="cyan",this.genMarker(),this.genFeatures(),this.genFloor(),this.genDoors(),this.genDirMarks(),this.genStunEffect(),this.genStairsDown(),t.shadowColor="white",t.strokeStyle="white",this.genWalls(),t.shadowColor="red",t.strokeStyle="red",this.genEnemies();const r=(l/e.tileFullSize|0)*(a/e.tileFullSize|0);console.log(`cache:${this.cacheLastIdx}/${r} (%${100*this.cacheLastIdx/r})`)}genMarker(){let t=this.getCacheRecord("marker");for(let e=0;e<8;++e){t.addFrame(this.getNextCachePos());let i=[];for(let t=0;t<4;++t){i.push([c.begin]);let s=[c.arc,.5,.5,.55],r=2*(1&t)-1,o=e/8*r+(2&t)/2,n=o+r/10;s.push(o,n,r>0?0:1),i.push(s,[c.stroke])}this.drawFigure(i,1,!1)}}genStunEffect(){let t=this.ctx;t.shadowColor="white",t.strokeStyle="white";let e=this.getCacheRecord("stun-effect"),i=[0,.5,1,1.5];for(let t=0;t<20;++t){e.addFrame(this.getNextCachePos());for(let t=0;t<4;++t){let e=.5+d(i[t])/2,s=.5+d(i[t]+.15)/2,r=.1+.1*u(i[t])/2,o=.1+.1*u(i[t]+.15)/2;this.drawFigure([[c.line,e,r,s,o]],1),i[t]+=.05}}}genDirMarks(){let t=this.ctx;t.shadowColor="lightgrey",t.strokeStyle="lightgrey";let e=this.getCacheRecord("dir-up");e.addFrame(this.getNextCachePos()),this.drawFigure([[c.line,.25,.75,.5,.5,.75,.75]],1),(e=this.getCacheRecord("dir-down")).addFrame(this.getNextCachePos()),this.drawFigure([[c.line,.25,.25,.5,.5,.75,.25]],1),(e=this.getCacheRecord("dir-left")).addFrame(this.getNextCachePos()),this.drawFigure([[c.line,.75,.25,.5,.5,.75,.75]],1),(e=this.getCacheRecord("dir-right")).addFrame(this.getNextCachePos()),this.drawFigure([[c.line,.25,.25,.5,.5,.25,.75]],1)}genFeatures(){this.ctx.lineWidth=2;let t=this.getCacheRecord("connector");t.addFrame(this.getNextCachePos());let e=[c.line,.1,.1,.9,.1,.9,.9,.1,.9,.1,.1];this.drawFigure([e,[c.line,.25,.5,.5,.25,.75,.5,.5,.75,.25,.5]],1),(t=this.getCacheRecord("data-box")).addFrame(this.getNextCachePos()),this.drawFigure([e,[c.line,.2,.3,.8,.3],[c.line,.2,.5,.8,.5],[c.line,.2,.7,.8,.7]],1),t=this.getCacheRecord("data-processor");for(let i=0;i<11;++i){t.addFrame(this.getNextCachePos());let s=.8*(i>4?10-i:i)/5,r=.8-s;this.drawFigure([e,[c.line,.1+s,.1,.1+r,.9]],1)}}genPlayer(){let t=this.ctx;t.shadowColor=o.idleColor,t.strokeStyle=o.idleColor;let e=this.getCacheRecord("player-1");e.addFrame(this.getNextCachePos()),this.drawFigure([[c.arc,.5,.5,.2,0,2],[c.stroke],[c.line,.7,.3,.7,.7],[c.line,.7,.7,.92,.7],[c.arc,.5,.5,.45,.12,.3,1]],1),t.shadowColor=o.impulseColor,t.strokeStyle=o.impulseColor,(e=this.getCacheRecord("player-2")).addFrame(this.getNextCachePos()),this.drawFigure([[c.arc,.5,.5,.2,0,2],[c.stroke],[c.line,.7,.3,.7,.7],[c.line,.7,.7,.8,.7,1,.5,.5,0,0,.5,.5,1,.7,.8]],1),t.shadowColor=o.impactColor,t.strokeStyle=o.impactColor,(e=this.getCacheRecord("player-3")).addFrame(this.getNextCachePos()),this.drawFigure([[c.arc,.5,.5,.2,0,2],[c.stroke],[c.line,.7,.3,.7,.7],[c.line,.7,.7,.85,.65,.8,.5,1,0,.5,.2,0,0,.2,.5,0,1,.5,.8,1,1,.9,.8]],1)}genConnection(t){let e=this.getCacheRecord(t+"-connection-piece-lr");for(let t=0;t<25;++t){e.addFrame(this.getNextCachePos());let i=[c.line],s=[c.line];g(i,s,t,0,1),this.drawFigure([i,s],1)}e=this.getCacheRecord(t+"-connection-piece-tb");for(let t=0;t<25;++t){e.addFrame(this.getNextCachePos());let i=[c.line],s=[c.line];_(i,s,t,0,1.1),this.drawFigure([i,s],1)}let i=[c.line,.25,.25,.25,.75,.75,.75,.75,.25,.25,.25];e=this.getCacheRecord(t+"-connection-piece-bl");for(let t=0;t<25;++t){e.addFrame(this.getNextCachePos());let s=[c.line],r=[c.line];g(s,r,t,0,.3);let o=s.length,n=r.length;s.push(0,s[o-1]),r.push(0,r[n-1]),_(s,r,t,.7,1.1),s[o]=s[o+2],r[n]=r[n+2],this.drawFigure([s,r,i],1)}e=this.getCacheRecord(t+"-connection-piece-br");for(let t=0;t<25;++t){e.addFrame(this.getNextCachePos());let s=[c.line],r=[c.line];g(s,r,t,.7,1.1),y(s),y(r);let o=s.length,n=r.length;s.push(0,s[o-1]),r.push(0,r[n-1]),_(s,r,t,.7,1.1),s[o]=s[o+2],r[n]=r[n+2],this.drawFigure([s,r,i],1)}e=this.getCacheRecord(t+"-connection-piece-tl");for(let t=0;t<25;++t){e.addFrame(this.getNextCachePos());let s=[c.line],r=[c.line];g(s,r,t,0,.3);let o=s.length,n=r.length;s.push(0,s[o-1]),r.push(0,r[n-1]),_(s,r,t,0,.3),y(s,o+2),y(r,n+2),s[o]=s[o+2],r[n]=r[n+2],this.drawFigure([s,r,i],1)}e=this.getCacheRecord(t+"-connection-piece-tr");for(let t=0;t<25;++t){e.addFrame(this.getNextCachePos());let s=[c.line],r=[c.line];_(s,r,t,0,.3);let o=s.length,n=r.length;s.push(s[o-2],0),r.push(r[n-2],0),g(s,r,t,.7,1.1),s[o+1]=s[o+3],r[n+1]=r[n+3],this.drawFigure([s,r,i],1)}e=this.getCacheRecord(t+"-connection-piece-tlr");for(let t=0;t<25;++t){e.addFrame(this.getNextCachePos());let s=[c.line],r=[c.line];_(s,r,t,0,.3);let o=s.length,n=r.length,h=s[o-2],l=r[n-2];s.push(s[o-2],0),r.push(r[n-2],0),g(s,r,t,.7,1.1),s[o+1]=s[o+3],r[n+1]=r[n+3];let a=s[o+3],u=r[n+3];this.drawFigure([s,r,i],1),g(s=[c.line],r=[c.line],t,0,.3),s.push(h,a),r.push(l,u),this.drawFigure([s,r],1)}e=this.getCacheRecord(t+"-connection-piece-blr");for(let t=0;t<25;++t){e.addFrame(this.getNextCachePos());let s=[c.line],r=[c.line];g(s,r,t,0,.3);let o=s.length,n=r.length;s.push(0,s[o-1]),r.push(0,r[n-1]);let h=s[o-1],l=r[n-1];_(s,r,t,.7,1.1),s[o]=s[o+2],r[n]=r[n+2];let a=s[o+2],u=r[n+2];this.drawFigure([s,r,i],1),s=[c.line],r=[c.line],s.push(a,h),r.push(u,l),g(s,r,t,.7,1.1),this.drawFigure([s,r],1)}e=this.getCacheRecord(t+"-connection-piece-tbl");for(let t=0;t<25;++t){e.addFrame(this.getNextCachePos());let s=[c.line],r=[c.line];g(s,r,t,0,.3);let o=s.length,n=r.length;s.push(0,s[o-1]),r.push(0,r[n-1]);let h=s[o-1],l=r[n-1];_(s,r,t,0,.3),y(s,o+2),y(r,n+2),s[o]=s[o+2],r[n]=r[n+2];let a=s[o+2],u=r[n+2];this.drawFigure([s,r,i],1),s=[c.line],r=[c.line],s.push(a,h),r.push(u,l),_(s,r,t,.7,1.1),this.drawFigure([s,r],1)}e=this.getCacheRecord(t+"-connection-piece-tbr");for(let t=0;t<25;++t){e.addFrame(this.getNextCachePos());let s=[c.line],r=[c.line];_(s,r,t,0,.3);let o=s.length,n=r.length;s.push(s[o-2],0),r.push(r[n-2],0);let h=s[o-2],l=r[n-2];g(s,r,t,.7,1.1),s[o+1]=s[o+3],r[n+1]=r[n+3];let a=s[o+3],u=r[n+3];this.drawFigure([s,r,i],1),s=[c.line],r=[c.line],s.push(h,a),r.push(l,u),_(s,r,t,.7,1.1),this.drawFigure([s,r],1)}e=this.getCacheRecord(t+"-connection-piece-tblr");for(let t=0;t<25;++t){e.addFrame(this.getNextCachePos());let s=[c.line],r=[c.line];_(s,r,t,0,.3);let o=s.length,n=r.length;s.push(s[o-2],0),r.push(r[n-2],0);let h=s[o-2],l=r[n-2];g(s,r,t,.7,1.1),s[o+1]=s[o+3],r[n+1]=r[n+3];let a=s[o+3],u=r[n+3];this.drawFigure([s,r,i],1),s=[c.line],r=[c.line],s.push(h,a),r.push(l,u),_(s,r,t,.7,1.1),this.drawFigure([s,r],1),g(s=[c.line],r=[c.line],t,0,.3),s.push(h,a),r.push(l,u),this.drawFigure([s,r],1)}e=this.getCacheRecord(t+"-connection-piece-t");for(let t=0;t<25;++t){e.addFrame(this.getNextCachePos());let i=[c.line],s=[c.line];_(i,s,t,0,.3);let r=[i,s,[c.arc,.5,.5,.3,0,2]];m(r,t),this.drawFigure(r,1)}e=this.getCacheRecord(t+"-connection-piece-b");for(let t=0;t<25;++t){e.addFrame(this.getNextCachePos());let i=[c.line],s=[c.line];_(i,s,t,.7,1.1);let r=[i,s,[c.arc,.5,.5,.3,0,2]];m(r,t),this.drawFigure(r,1)}e=this.getCacheRecord(t+"-connection-piece-l");for(let t=0;t<25;++t){e.addFrame(this.getNextCachePos());let i=[c.line],s=[c.line];g(i,s,t,0,.3);let r=[i,s,[c.arc,.5,.5,.3,0,2]];m(r,t),this.drawFigure(r,1)}e=this.getCacheRecord(t+"-connection-piece-r");for(let t=0;t<25;++t){e.addFrame(this.getNextCachePos());let i=[c.line],s=[c.line];g(i,s,t,.7,1.1);let r=[i,s,[c.arc,.5,.5,.3,0,2]];m(r,t),this.drawFigure(r,1)}}genEnemies(){this.ctx.lineWidth=1.5;let t=this.getCacheRecord("muncher");for(let e=0;e<5;++e){t.addFrame(this.getNextCachePos());let i=e/20;this.drawFigure([[c.arc,.5,.5,.45,0,2],[c.arc,.3,.3,.04,0,2],[c.arc,.7,.3,.04,0,2],[c.line,.25,.75+i,.375,.625+i],[c.line,.375,.625+i,.5,.75+i],[c.line,.5,.75+i,.625,.625+i],[c.line,.625,.625+i,.75,.75+i],[c.line,.25,.75-i,.375,.625-i],[c.line,.375,.625-i,.5,.75-i],[c.line,.5,.75-i,.625,.625-i],[c.line,.625,.625-i,.75,.75-i]],2)}t=this.getCacheRecord("spyware");for(let e=0;e<10;++e){t.addFrame(this.getNextCachePos());let i=.15*e/10;this.drawFigure([[c.arc,.5,.5,.45,0,2],[c.line,.2,.4,.2+i,.4],[c.line,.3+i,.4,.4,.4],[c.line,.6,.4,.6+i,.4],[c.line,.7+i,.4,.8,.4],[c.line,.25,.7,.75,.7]],2)}}genWallSegment(t,e){let i=this.getCacheRecord(t);for(let t=0;t<5;++t)i.addFrame(this.getNextCachePos()),this.drawFigure(e,1+t)}genWalls(){this.ctx.lineWidth=4,this.ctx.lineCap="round",this.genWallSegment("wall-tb",[[c.line,.5,0,.5,1]]),this.genWallSegment("wall-lr",[[c.line,0,.5,1,.5]]),this.genWallSegment("wall-tr",[[c.line,.5,0,.5,.25],[c.arc,.75,.25,.25,1,.5,1],[c.line,.75,.5,1,.5]]),this.genWallSegment("wall-tl",[[c.line,.5,0,.5,.25],[c.arc,.25,.25,.25,0,.5,0],[c.line,.25,.5,0,.5]]),this.genWallSegment("wall-br",[[c.line,.5,1,.5,.75],[c.arc,.75,.75,.25,1,1.5,0],[c.line,.75,.5,1,.5]]),this.genWallSegment("wall-bl",[[c.line,.5,1,.5,.75],[c.arc,.25,.75,.25,2,1.5,1],[c.line,.25,.5,0,.5]]),this.genWallSegment("wall-tbl",[[c.line,.5,0,.5,1],[c.line,0,.5,.5,.5]]),this.genWallSegment("wall-tbr",[[c.line,.5,0,.5,1],[c.line,.5,.5,1,.5]]),this.genWallSegment("wall-tlr",[[c.line,0,.5,1,.5],[c.line,.5,0,.5,.5]]),this.genWallSegment("wall-blr",[[c.line,0,.5,1,.5],[c.line,.5,.5,.5,1]]),this.genWallSegment("wall-tblr",[[c.line,0,.5,1,.5],[c.line,.5,0,.5,1]])}genFloor(){this.ctx.strokeStyle="#888888",this.getCacheRecord("floor").addFrame(this.getNextCachePos());this.ctx.lineWidth=1,this.ctx.shadowColor="#888888",this.drawFigure([[c.arc,.5,.5,.1,0,2],[c.line,.5,.4,.5,0],[c.line,.5,.6,.5,1],[c.line,.4,.5,0,.5],[c.line,.6,.5,1,.5]],1)}genStairsDown(){this.ctx.strokeStyle="#aaaaaa",this.getCacheRecord("stairs-down").addFrame(this.getNextCachePos());let t=[[c.line,0,0,1,0,1,1,0,1,0,0]],e=.2,i=1-e,s=.8;for(let r=0;r<5;++r)t.push([c.line,i,s,i+e,s,i+e,s+.2,i,s+.2,i,s]),s-=.2,i=1-(e+=.2);this.drawFigure(t,1)}genDoorFrame(t,e){let i=e/10,s=t+i,r=1+t-i,o=1+t+i,n=2+t-i,h=.5+.5*u(s),l=.5+.5*d(s),a=.5+.5*u(r),p=.5+.5*d(r),f=.5+.5*u(o),g=.5+.5*d(o),_=.5+.5*u(n),m=.5+.5*d(n);this.drawFigure([[c.arc,.5,.5,.5,s,r],[c.arc,.5,.5,.5,o,n],[c.line,h,l,a,p],[c.line,f,g,_,m]],1)}genDoors(){this.ctx.strokeStyle="#FFFFFF",this.ctx.shadowColor="#FFFFFF",this.ctx.lineWidth=2;let t=this.getCacheRecord("door-h");for(let e=0;e<5;++e)t.addFrame(this.getNextCachePos()),this.genDoorFrame(.5,e);(t=this.getCacheRecord("door-h-locked")).addFrame(this.getNextCachePos()),this.genDoorFrame(.5,0),this.drawFigure([[c.arc,.5,.5,.2,1,2],[c.line,.3,.5,.7,.5,.7,.8,.3,.8,.3,.5]],1),(t=this.getCacheRecord("door-h-blocked")).addFrame(this.getNextCachePos()),this.genDoorFrame(.5,0),this.drawFigure([[c.line,.2,.2,.8,.8],[c.line,.2,.8,.8,.2]],1),t=this.getCacheRecord("door-v");for(let e=0;e<5;++e)t.addFrame(this.getNextCachePos()),this.genDoorFrame(0,e);(t=this.getCacheRecord("door-v-locked")).addFrame(this.getNextCachePos()),this.genDoorFrame(0,0),this.drawFigure([[c.arc,.5,.5,.2,1,2],[c.line,.3,.5,.7,.5,.7,.8,.3,.8,.3,.5]],1),(t=this.getCacheRecord("door-v-blocked")).addFrame(this.getNextCachePos()),this.genDoorFrame(.5,0),this.drawFigure([[c.line,.2,.2,.8,.8],[c.line,.2,.8,.8,.2]],1)}drawTile(t,i,s=0){let o=r.getCtx(),h=this.cache[i];if(h){let i=h.frames.length;s=(s%i+i)%i;let r=h.frames[s];return o.drawImage(this.cacheCanvas,r.outerRect.pos.x,r.outerRect.pos.y,e.tileFullSize,e.tileFullSize,t.x-n,t.y-n,e.tileFullSize,e.tileFullSize),i}return 0}drawTileTinted(t,i,s,o=0,l=!1){let a=r.getCtx(),c=this.cache[i];if(c){let i=c.frames.length;o=(o%i+i)%i;let r=c.frames[o],u=a.globalCompositeOperation;return a.drawImage(this.cacheCanvas,r.outerRect.pos.x,r.outerRect.pos.y,e.tileFullSize,e.tileFullSize,t.x-n,t.y-n,e.tileFullSize,e.tileFullSize),a.globalCompositeOperation="multiply",a.fillStyle=s,l?a.fillRect(t.x-n,t.y-n,e.tileFullSize,e.tileFullSize):a.fillRect(t.x+h,t.y+h,e.tileSize+n,e.tileSize+n),a.globalCompositeOperation=u,i}return 0}getTileFrames(t){let e=this.cache[t];if(e)return e.frames.length}}b.instance=new b,e.TileManager=b},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(8);class o extends r.UIBase{constructor(){super(...arguments),this.objects=new Array,this.currentMouseOver=null,this.modal=null,this.modalsStack=[]}add(t){t.parent=this,this.objects.push(t),t.onAdd&&t.onAdd()}showModal(t){this.objects.forEach(t=>t.pauseBindings()),this.modal&&(this.modalsStack.push(this.modal),this.modal.pauseBindings()),t.parent=this,this.modal=t,t.onAdd&&t.onAdd()}remove(t){t.onRemove&&t.onRemove(),t===this.modal?(this.objects.forEach(t=>t.resumeBindings()),this.modalsStack.length?(this.modal=this.modalsStack.pop(),this.modal.resumeBindings()):this.modal=null):this.objects=this.objects.filter(e=>e!==t)}postMouseEvent(t,e){let i,r=new s.Pos(e.x,e.y);if(this.modal)if(this.modal instanceof o)this.modal.postMouseEvent(t,e);else{let i=this.getHandler(t);i&&i.call(this.modal,e)}else if(this.objects.forEach(function(s){if(s.isInside(r)){i=s;let r=s.getHandler(t);r&&r.call(s,e)}}),"onMouseMove"===t&&i!==this.currentMouseOver&&(this.currentMouseOver&&this.currentMouseOver.onMouseLeave(e),i&&i.onMouseEnter(e),this.currentMouseOver=i),i instanceof o)i.postMouseEvent(t,e);else{let i=this.getHandler(t);i&&i.call(this,e)}}onMouseLeave(t){this.objects.forEach(e=>e.onMouseLeave(t)),this.currentMouseOver=null,super.onMouseLeave(t)}draw(){if(this.objects.forEach(t=>t.draw()),this.modal){for(let t of this.modalsStack)t.draw();this.modal.draw()}}pauseBindings(){super.pauseBindings(),this.objects.forEach(t=>t.pauseBindings())}resumeBindings(){super.resumeBindings(),this.objects.forEach(t=>t.resumeBindings())}autoSize(){let t=new s.Size,e=this;return this.objects.forEach(function(i){let s=i.rect.bottomRight().sub(e.rect.pos);s.x>t.width&&(t.width=s.x),s.y>t.height&&(t.height=s.y)}),this.rect.size.assign(t),t}}e.UIContainer=o},function(t,e,i){"use strict";i.r(e),i.d(e,"fromString",function(){return o}),i.d(e,"add",function(){return n}),i.d(e,"add_",function(){return h}),i.d(e,"multiply",function(){return l}),i.d(e,"multiply_",function(){return a}),i.d(e,"interpolate",function(){return c}),i.d(e,"lerp",function(){return u}),i.d(e,"interpolateHSL",function(){return d}),i.d(e,"lerpHSL",function(){return p}),i.d(e,"randomize",function(){return f}),i.d(e,"rgb2hsl",function(){return g}),i.d(e,"hsl2rgb",function(){return m}),i.d(e,"toRGB",function(){return y}),i.d(e,"toHex",function(){return b});var s=i(3),r=i(0);function o(t){let e,i;if(t in w)e=w[t];else{if("#"==t.charAt(0)){let i=(t.match(/[0-9a-f]/gi)||[]).map(t=>parseInt(t,16));if(3==i.length)e=i.map(t=>17*t);else{for(let t=0;t<3;t++)i[t+1]+=16*i[t],i.splice(t,1);e=i}}else e=(i=t.match(/rgb\(([0-9, ]+)\)/i))?i[1].split(/\s*,\s*/).map(t=>parseInt(t)):[0,0,0];w[t]=e}return e.slice()}function n(t,...e){let i=t.slice();for(let t=0;t<3;t++)for(let s=0;s<e.length;s++)i[t]+=e[s][t];return i}function h(t,...e){for(let i=0;i<3;i++)for(let s=0;s<e.length;s++)t[i]+=e[s][i];return t}function l(t,...e){let i=t.slice();for(let t=0;t<3;t++){for(let s=0;s<e.length;s++)i[t]*=e[s][t]/255;i[t]=Math.round(i[t])}return i}function a(t,...e){for(let i=0;i<3;i++){for(let s=0;s<e.length;s++)t[i]*=e[s][i]/255;t[i]=Math.round(t[i])}return t}function c(t,e,i=.5){let s=t.slice();for(let r=0;r<3;r++)s[r]=Math.round(s[r]+i*(e[r]-t[r]));return s}const u=c;function d(t,e,i=.5){let s=g(t),r=g(e);for(let t=0;t<3;t++)s[t]+=i*(r[t]-s[t]);return m(s)}const p=d;function f(t,e){e instanceof Array||(e=Math.round(r.a.getNormal(0,e)));let i=t.slice();for(let t=0;t<3;t++)i[t]+=e instanceof Array?Math.round(r.a.getNormal(0,e[t])):e;return i}function g(t){let e,i=t[0]/255,s=t[1]/255,r=t[2]/255,o=Math.max(i,s,r),n=Math.min(i,s,r),h=0,l=(o+n)/2;if(o==n)e=0;else{let t=o-n;switch(e=l>.5?t/(2-o-n):t/(o+n),o){case i:h=(s-r)/t+(s<r?6:0);break;case s:h=(r-i)/t+2;break;case r:h=(i-s)/t+4}h/=6}return[h,e,l]}function _(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t}function m(t){let e=t[2];if(0==t[1])return[e=Math.round(255*e),e,e];{let i=t[1],s=e<.5?e*(1+i):e+i-e*i,r=2*e-s,o=_(r,s,t[0]+1/3),n=_(r,s,t[0]),h=_(r,s,t[0]-1/3);return[Math.round(255*o),Math.round(255*n),Math.round(255*h)]}}function y(t){return`rgb(${t.map(t=>Object(s.clamp)(t,0,255)).join(",")})`}function b(t){return`#${t.map(t=>Object(s.clamp)(t,0,255).toString(16).padStart(2,"0")).join("")}`}const w={black:[0,0,0],navy:[0,0,128],darkblue:[0,0,139],mediumblue:[0,0,205],blue:[0,0,255],darkgreen:[0,100,0],green:[0,128,0],teal:[0,128,128],darkcyan:[0,139,139],deepskyblue:[0,191,255],darkturquoise:[0,206,209],mediumspringgreen:[0,250,154],lime:[0,255,0],springgreen:[0,255,127],aqua:[0,255,255],cyan:[0,255,255],midnightblue:[25,25,112],dodgerblue:[30,144,255],forestgreen:[34,139,34],seagreen:[46,139,87],darkslategray:[47,79,79],darkslategrey:[47,79,79],limegreen:[50,205,50],mediumseagreen:[60,179,113],turquoise:[64,224,208],royalblue:[65,105,225],steelblue:[70,130,180],darkslateblue:[72,61,139],mediumturquoise:[72,209,204],indigo:[75,0,130],darkolivegreen:[85,107,47],cadetblue:[95,158,160],cornflowerblue:[100,149,237],mediumaquamarine:[102,205,170],dimgray:[105,105,105],dimgrey:[105,105,105],slateblue:[106,90,205],olivedrab:[107,142,35],slategray:[112,128,144],slategrey:[112,128,144],lightslategray:[119,136,153],lightslategrey:[119,136,153],mediumslateblue:[123,104,238],lawngreen:[124,252,0],chartreuse:[127,255,0],aquamarine:[127,255,212],maroon:[128,0,0],purple:[128,0,128],olive:[128,128,0],gray:[128,128,128],grey:[128,128,128],skyblue:[135,206,235],lightskyblue:[135,206,250],blueviolet:[138,43,226],darkred:[139,0,0],darkmagenta:[139,0,139],saddlebrown:[139,69,19],darkseagreen:[143,188,143],lightgreen:[144,238,144],mediumpurple:[147,112,216],darkviolet:[148,0,211],palegreen:[152,251,152],darkorchid:[153,50,204],yellowgreen:[154,205,50],sienna:[160,82,45],brown:[165,42,42],darkgray:[169,169,169],darkgrey:[169,169,169],lightblue:[173,216,230],greenyellow:[173,255,47],paleturquoise:[175,238,238],lightsteelblue:[176,196,222],powderblue:[176,224,230],firebrick:[178,34,34],darkgoldenrod:[184,134,11],mediumorchid:[186,85,211],rosybrown:[188,143,143],darkkhaki:[189,183,107],silver:[192,192,192],mediumvioletred:[199,21,133],indianred:[205,92,92],peru:[205,133,63],chocolate:[210,105,30],tan:[210,180,140],lightgray:[211,211,211],lightgrey:[211,211,211],palevioletred:[216,112,147],thistle:[216,191,216],orchid:[218,112,214],goldenrod:[218,165,32],crimson:[220,20,60],gainsboro:[220,220,220],plum:[221,160,221],burlywood:[222,184,135],lightcyan:[224,255,255],lavender:[230,230,250],darksalmon:[233,150,122],violet:[238,130,238],palegoldenrod:[238,232,170],lightcoral:[240,128,128],khaki:[240,230,140],aliceblue:[240,248,255],honeydew:[240,255,240],azure:[240,255,255],sandybrown:[244,164,96],wheat:[245,222,179],beige:[245,245,220],whitesmoke:[245,245,245],mintcream:[245,255,250],ghostwhite:[248,248,255],salmon:[250,128,114],antiquewhite:[250,235,215],linen:[250,240,230],lightgoldenrodyellow:[250,250,210],oldlace:[253,245,230],red:[255,0,0],fuchsia:[255,0,255],magenta:[255,0,255],deeppink:[255,20,147],orangered:[255,69,0],tomato:[255,99,71],hotpink:[255,105,180],coral:[255,127,80],darkorange:[255,140,0],lightsalmon:[255,160,122],orange:[255,165,0],lightpink:[255,182,193],pink:[255,192,203],gold:[255,215,0],peachpuff:[255,218,185],navajowhite:[255,222,173],moccasin:[255,228,181],bisque:[255,228,196],mistyrose:[255,228,225],blanchedalmond:[255,235,205],papayawhip:[255,239,213],lavenderblush:[255,240,245],seashell:[255,245,238],cornsilk:[255,248,220],lemonchiffon:[255,250,205],floralwhite:[255,250,240],snow:[255,250,250],yellow:[255,255,0],lightyellow:[255,255,224],ivory:[255,255,240],white:[255,255,255]}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(25);i(26);const r=i(2);e.MyMouseEvent=class{constructor(t,e,i){this.x=t,this.y=e,this.original=i}};e.UIBase=class{constructor(){this.rect=r.getAppRect().clone(),this.bindings=new s,this.mouseOver=!1,this.clickOnUp=!1}draw(){}close(){this.parent.remove(this)}isInside(t){return this.rect.isInside(t)}pauseBindings(){this.bindings.pause()}resumeBindings(){this.bindings.unpause()}centerX(t){void 0===t&&(t=this.parent.rect.size.width/2),this.rect.pos.x=t-this.rect.size.width/2}onMouseMove(t){}onMouseEnter(t){this.mouseOver=!0}onMouseLeave(t){this.mouseOver=!1,this.clickOnUp=!1}onMouseDown(t){this.clickOnUp=!0}onMouseUp(t){this.clickOnUp&&this.onClick&&this.onClick(t),this.clickOnUp=!1}getHandler(t){return this[t]}onRemove(){this.bindings.reset()}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.FwdAndBackAnimation=class{constructor(t,e,i=0){this.onFrame=t,this.maxFrame=e,this.minFrame=i,this.frame=i,this.dir=1}nextFrame(){return this.frame+=this.dir,(this.frame>=this.maxFrame||this.frame<=this.minFrame)&&(this.dir=-this.dir),this.onFrame(this.frame)}};e.CyclicAnimation=class{constructor(t,e,i=0,s=i){this.onFrame=t,this.maxFrame=e,this.minFrame=i,this.frame=s}nextFrame(){return this.frame+=1,this.frame>=this.maxFrame&&(this.frame=this.minFrame),this.onFrame(this.frame)}};e.OneTimeAnimation=class{constructor(t,e,i=0){this.onFrame=t,this.maxFrame=e,this.frame=i,this.dir=i>e?-1:1}nextFrame(){return this.frame+=this.dir,!(this.dir>0?this.frame>=this.maxFrame:this.frame<=this.maxFrame)&&this.onFrame(this.frame)}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(8),r=i(2);e.Label=class extends s.UIBase{constructor(t,e,i="white",s=16){super(),this.color=i,this.fontSize=s,this.rect.pos.assign(t),this.setLabel(e)}setLabel(t){this.label=t,r.setFontSize(this.fontSize),this.rect.size.assign(r.getTextSize(t))}draw(){r.setFontSize(this.fontSize),r.textout(this.rect.pos.x,this.rect.pos.y,this.color,this.label)}}},function(t,e,i){"use strict";i.d(e,"a",function(){return s});class s{getContainer(){return null}setOptions(t){this._options=t}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(8),r=i(2);class o extends s.UIBase{constructor(t,e,i){super(),this.color="white",this.fontSize=32,this.label=t,this.onClick=e;let s=0,o=0;i&&(i.fontSize&&(this.fontSize=i.fontSize),i.minWidth&&(s=i.minWidth),i.minHeight&&(o=i.minHeight)),r.setFontSize(this.fontSize),this.rect.size.assign(r.getTextSize(t)),this.rect.size.width+=4,this.rect.size.height+=4,this.rect.size.width<s&&(this.rect.size.width=s),this.rect.size.height<o&&(this.rect.size.height=o),this.labelPos=this.rect.size.toPos().sub(r.getTextSize(this.label).toPos()).div(2)}draw(){r.setFontSize(this.fontSize),r.rect(this.rect,"lightgrey",2,this.mouseOver?10:0);let t=this.labelPos.clone().add(this.rect.pos);r.textout(t.x,t.y,this.color,this.label)}}e.Button=o;e.CloseButton=class extends o{constructor(){super("X",()=>this.doClose()),this.color="red"}doClose(){this.parent.close(),this.onClose&&this.onClose()}onAdd(){this.rect.pos.assign(this.parent.rect.pos),this.rect.pos.x+=this.parent.rect.size.width-32,this.rect.size.width=32,this.rect.size.height=32}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(1),o=i(29),n=i(4),h=i(5);e.Entity=class{constructor(){this.tileFrame=0,this.pos=new r.Pos,this.alive=!0,this.blocking=!0,this.speed=1,this.effects=[]}onFrame(t){return this.tileFrame=t,this.alive}onTurn(){}interactWith(){return!0}getDamage(){return 0}onMove(){}getHp(){return 0}stun(t){}hasEffect(t){return this.effects.some(e=>e.id==t)}addEffect(t){this.effects.push(t)}cancelEffect(t){this.effects=this.effects.filter(e=>e.id!=t)}startFloatingText(t,e,i){let l=s.pdiffToDir(i,this.pos),a=new r.Pos(s.dirX[l],s.dirY[l]).mul(h.tileSize/4);n.uiManager.addAnimation(new o.FloatingTextAni(t,e,this.map.mapToScreen(this.pos).add(h.tileSize/2,h.tileSize/2),a))}moveTo(t){let e=this.map,i=t.clone(),s=e.mapGet(this.pos.x,this.pos.y),r=e.mapGet(i.x,i.y);return!r.hasBlockingEntity()&&(r.addEntity(this),s.removeEntity(this),this.pos=i,!0)}move(t){let e=this.pos.clone();e.x+=s.dirX[t],e.y+=s.dirY[t],this.moveTo(e)&&this.onMove()}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.Resource=class{constructor(t,e){this.value=0,this.descr=t,this.color=e}setMaxValue(t){this.maxValue=t,this.value=t}isAtMax(){return this.value>=this.maxValue}add(t){return this.value+=t,this.value>this.maxValue&&(this.value=this.maxValue),this.value}sub(t){let e=Math.min(this.value,t);return this.value-=e,t-=e}},function(t){t[t.health=0]="health",t[t.shield=1]="shield",t[t.idleCharge=2]="idleCharge",t[t.impulseCharge=3]="impulseCharge",t[t.impactCharge=4]="impactCharge",t[t.count=5]="count"}(e.RES||(e.RES={}))},function(t,e,i){"use strict";(function(t){i.d(e,"a",function(){return n});var s=i(11),r=i(7);function o(t){let e=r.fromString(t);return 36*Math.floor(e[0]*(6/256))+6*Math.floor(e[1]*(6/256))+1*Math.floor(e[2]*(6/256))+16}class n extends s.a{constructor(){super(),this._offset=[0,0],this._cursor=[-1,-1],this._lastColor=""}schedule(t){setTimeout(t,1e3/60)}setOptions(t){super.setOptions(t);let e=[t.width,t.height],i=this.computeSize();this._offset=i.map((t,i)=>Math.floor((t-e[i])/2))}clear(){t.stdout.write(`[0;48;5;${o(this._options.bg)}m[2J`)}draw(e,i){let[s,r,n,h,l]=e,a=this._offset[0]+s,c=this._offset[1]+r,u=this.computeSize();if(a<0||a>=u[0])return;if(c<0||c>=u[1])return;if(a===this._cursor[0]&&c===this._cursor[1]||(t.stdout.write(function(t,e){return`[${e+1};${t+1}H`}(a,c)),this._cursor[0]=a,this._cursor[1]=c),i&&(n||(n=" ")),!n)return;let d=function(t,e){return`[0;38;5;${o(t)};48;5;${o(e)}m`}(h,l);d!==this._lastColor&&(t.stdout.write(d),this._lastColor=d);let p=[].concat(n);t.stdout.write(p[0]),this._cursor[0]++,this._cursor[0]>=u[0]&&(this._cursor[0]=0,this._cursor[1]++)}computeFontSize(){throw new Error("Terminal backend has no notion of font size")}eventToPosition(t,e){return[t,e]}computeSize(){return[t.stdout.columns,t.stdout.rows]}}}).call(this,i(36))},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(12),r=i(9),o=i(5),n=i(4),h=i(6),l=i(2),a=i(1),c=i(27),u=i(23),d="v0.02",p="Made by Konstantin Stupnik aka Xecutor for 7DRL 2019 ";let f=["br lr lr bl    br lr lr bl    br lr lr bl ","tr bl br tl    tr bl br tl    tr bl br tl ","   tb tb          tb tb          tb tb    ","   tb tb          tb tb          tb tb    ","br tl tr bl    br tl tr bl    br tl tr bl ","tr lr lr tl    tr lr lr tl    tr lr lr tl "];e.MainMenu=class extends h.UIContainer{constructor(){super(),this.ani=null;let t={minWidth:256,minHeight:64},e=new s.Button("Start",()=>this.startGame(),t),i=this.rect.size.toPos().div(2);i.x-=128,e.rect.pos.assign(i),this.add(e),i.y+=96,(e=new s.Button("Quit",()=>this.quitGame(),t)).rect.pos.assign(i),this.add(e)}startGame(){this.close(),n.uiManager.add(new c.CharSelector)}quitGame(){u.showMessageBox(a.randomFromArray(["Rly?","Srsly?","Sure?","Oh my...","Oh no...","Nope","Rethink please!","Ah...","Uhh...","LALALA, not hearing you!","Anything, but that!","Gosh...","To quit or not to quit, that is the question.","One cannot simply quit playing a roguelike game!"]))}draw(){super.draw();const t=["cyan","yellow","magenta"];for(let e=0;e<f.length;++e){let i=f[e],s=o.tileSize*e,r=new a.Pos((this.rect.size.width-14*o.tileSize)/2,s);for(let e=0;e<i.length;e+=3,r.x+=o.tileSize){let s=i.substr(e,3);for(;s.length&&" "==s.charAt(s.length-1);)s=s.substr(0,s.length-1);0!=s.length&&o.TileManager.instance.drawTileTinted(r,"wall-"+s,t[3*e/i.length|0],this.frame,!0)}}l.setFontSize(16);let e=l.getTextSize(d),i=this.rect.size.height-e.height;l.textout(0,i,"lightgrey",p),l.textout(this.rect.size.width-e.width,i,"lightgrey",d),Math.random()<.008&&!this.ani&&(this.ani=new r.FwdAndBackAnimation(t=>this.onFrame(t),4,0),n.uiManager.addAnimation(this.ani))}onFrame(t){return this.frame=t,this.frame||(this.ani=null),0!=t}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.idleColor="cyan",e.impulseColor="yellow",e.impactColor="magenta"},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(19),o=i(20),n=i(30);var h;!function(t){t[t.normal=0]="normal",t[t.locked=1]="locked"}(h||(h={})),e.isNextToExplored=function(t,e){return t.doors.some(t=>e[t.dstRoomIdx].explored)};const l=31,a=4,c=[7,9,12,15,18];e.RoomsGenerator=class{constructor(t){this.depth=t,this.rooms=[]}fixWallConn(){let t=this.m;for(let e=t.mapRect.getIterator();e.next();){let i=t.mapPGet(e.value);if(i&&(i.tile instanceof r.WallTile||i.alwaysVis))for(let o=0;o<4;++o){let n=t.mapGet(e.value.x+s.dirX[o],e.value.y+s.dirY[o]);n&&(n.tile instanceof r.WallTile||n.alwaysVis)&&(i.conn[o]=!0)}}}generate(t){this.m=t;let e=c[this.depth-1],i=this.rooms;i.push({pos:new s.Pos(0,0),doors:[],mrect:new s.Rect(new s.Pos,new s.Size(l,l))});let u=[];for(let t=0;t<4;++t)u.push({fromRoomIdx:0,pos:new s.Pos(s.dirX[t],s.dirY[t]),dir:s.dirArray[t],weight:100});for(;i.length<e;){let t=s.weightedRandomFromArray(u,t=>t.weight);t.weight=0;for(let e of u)e.fromRoomIdx==t.fromRoomIdx&&0!=e.weight&&(e.weight-=25);let e=i.length;i[t.fromRoomIdx].doors.push({dir:t.dir,type:h.normal,dstRoomIdx:e}),console.log(`adding room at pos:${t.pos.x}, ${t.pos.y}`),i.push({pos:t.pos.clone(),doors:[{dir:s.inverseDir[t.dir],type:h.normal,dstRoomIdx:t.fromRoomIdx}],mrect:new s.Rect(t.pos.clone().mul(l+a),new s.Size(l,l))});for(let r=0;r<4;++r){let o=new s.Pos(t.pos.x+s.dirX[r],t.pos.y+s.dirY[r]);u.find(t=>t.pos.isEqual(o))||i.find(t=>t.pos.isEqual(o))||u.push({fromRoomIdx:e,pos:o,dir:s.dirArray[r],weight:100})}}let d=0;for(let e of i){let i=e.mrect,s=i.getIterator();for(;s.next();){let e;(e=i.isStrictlyInside(s.value)?t.mapPSet(s.value,new r.FloorTile):t.mapPSet(s.value,new r.WallTile)).roomIdx=d}++d}for(let t=0;t<i.length;++t)console.log(`doors for room ${t}:`,i[t].doors);for(let e of i){let i=new s.Rect(e.pos.clone().mul(l+a),new s.Size(l,l));for(let n of e.doors){let e,h;n.corrIdx=d;let c=s.dirArray[n.dir];switch(n.dir){case s.DIR.t:e=i.pos.clone().add(Math.floor(l/2),0),h=new s.Pos(-1,0);break;case s.DIR.b:e=i.pos.clone().add(Math.floor(l/2),l-1),h=new s.Pos(-1,0);break;case s.DIR.l:e=i.pos.clone().add(0,Math.floor(l/2)),h=new s.Pos(0,-1);break;case s.DIR.r:e=i.pos.clone().add(l-1,Math.floor(l/2)),h=new s.Pos(0,-1)}let u=t.mapGet(e.x+2*s.dirX[c],e.y+2*s.dirY[c]);if(u)n.corrIdx=u.roomIdx;else{for(let i=0;i<=a+1;++i){let l=0==i||i==a+1,u=t.mapPSet(e,new r.FloorTile);if(u.roomIdx=d,u.alwaysVis=l,l){let t=new o.Door(n.dir==s.DIR.l||n.dir==s.DIR.r,!1);u.addEntity(t)}(u=t.mapPSet(e.clone().add(h),new r.WallTile)).alwaysVis=l,u.roomIdx=d,(u=t.mapPSet(e.clone().sub(h),new r.WallTile)).alwaysVis=l,u.roomIdx=d,e.add(s.dirX[c],s.dirY[c])}++d}}}t.mapGet(5,5).tile=new r.StairsDownTile;for(let e=1;e<i.length;++e)for(let s=1;s<=2;++s)for(let r=1;r<=2;++r){let o=i[e].mrect,h=o.pos.clone().add(o.size.width*s/3,o.size.height*r/3);t.mapPGet(h).addEntity(new n.Muncher)}this.fixWallConn();for(let e=t.mapRect.getIterator();e.next();){let i=t.mapPGet(e.value);i&&i.tile&&i.update()}t.setEntrance(new s.Pos(Math.floor(l/2),Math.floor(l/2))),t.setRoomsInfo(this.rooms)}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(5),r=i(9),o=i(4),n=i(1);e.WallTile=class{constructor(){this.passable=!1,this.connector=!1,this.animate=!1}getTileName(t){let e="wall-";for(let i=0;i<t.length;++i)t[i]&&(e+=n.DIR[i]);return e}getDescription(){return"Wall"}};e.FloorTile=class{constructor(){this.passable=!0,this.animate=!1}getTileName(t){return"floor"}getDescription(){return"Floor"}};e.StairsDownTile=class{constructor(){this.passable=!1,this.animate=!1}getTileName(){return"stairs-down"}getDescription(){return"Staircase down"}};e.TileInfo=class{constructor(t){this.entities=[],this.conn=[!1,!1,!1,!1],this.tile=t,this.tileFrame=0,this.visible=!1,t&&(this.passable=t.passable)}update(){this.tileName=this.tile.getTileName(this.conn),this.tile.animate&&o.uiManager.addAnimation(new r.FwdAndBackAnimation(t=>this.onFrame(t),s.TileManager.instance.getTileFrames(this.tileName)))}onFrame(t){return this.tileFrame=t,!0}addConn(t){return this.conn[t]=!0,this}addEntity(t){this.entities.push(t),t.pos.assign(this.pos)}removeEntity(t){this.entities=this.entities.filter(e=>e!==t)}hasEntities(){return this.entities.length>0}hasBlockingEntity(){return this.entities.some(t=>t.blocking)}getBlockingEntity(){return this.entities.find(t=>t.blocking)}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(13),r=i(4),o=i(9),n=i(5);e.Door=class extends s.Entity{constructor(t,e){super(),this.isVertical=t,this.isLocked=e,this.updateTileName()}onTurn(){}getDescription(){return this.isBlocked?"Blocked door":this.isLocked?"Locked Door":"Door"}receiveDamage(){}updateTileName(){this.isBlocked?this.tileName=this.isVertical?"door-v-blocked":"door-h-blocked":this.isLocked?this.tileName=this.isVertical?"door-v-locked":"door-h-locked":this.tileName=this.isVertical?"door-v":"door-h"}block(){this.wasClosed=this.blocking,this.isBlocked=!0,this.blocking=!0,this.updateTileName()}unblock(){this.blocking=this.wasClosed,this.isBlocked=!1,this.updateTileName()}interactWith(){return!this.isBlocked&&(this.isLocked?(this.isLocked=!1,this.updateTileName(),!0):(this.blocking=!1,r.uiManager.addAnimation(new o.OneTimeAnimation(t=>this.onFrame(t),n.TileManager.instance.getTileFrames(this.tileName))),!0))}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(14),r=i(1);var o;!function(t){t[t.none=0]="none",t[t.direction=1]="direction",t[t.position=2]="position",t[t.enemy=3]="enemy"}(o=e.AbilityTargetType||(e.AbilityTargetType={}));e.AbilityTarget=class{};class n{getTargetType(){return o.none}activate(t){t.getResource(s.RES.shield).add(20),t.startFloatingText("20","lightblue",t.pos.clone().add(0,1))}getCost(){return n.cost}getName(){return"Shield Charge"}}n.cost=[{res:s.RES.idleCharge,amount:2}],e.ShieldRecharge=n;class h{getTargetType(){return o.direction}activate(t,e){let i=t.pos.clone(),s=i.clone().add(r.dirX[e.dir],r.dirY[e.dir]);for(let r=0;r<5;++r){let r=t.map.mapPGet(s);if(!r.passable)break;if(r.hasBlockingEntity())break;i.assign(s),s.addDir(e.dir)}t.moveTo(i);let o=t.map.mapPGet(s);if(o.hasBlockingEntity()){let e=o.entities.find(t=>t.isEnemy);e&&(e.receiveDamage(50,t),e.move(r.diffToDir(i.x,i.y,e.pos.x,e.pos.y)),e.stun(1))}}getCost(){return h.cost}getName(){return"Jump kick"}}h.cost=[{res:s.RES.impulseCharge,amount:3}],e.JumpKick=h;class l{activate(t,e){let i=t.pos.clone().addDir(e.dir),s=t.map.mapPGet(i);if(s.hasBlockingEntity()){let e=s.entities.find(t=>t.isEnemy);e&&(e.receiveDamage(50,t),e.stun(4))}}getTargetType(){return o.direction}getCost(){return l.cost}getName(){return"Stunning smash"}}l.cost=[{res:s.RES.impactCharge,amount:3}],e.StunningSmash=l},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(10),r=i(5),o=i(18),n=i(6),h=i(2),l=i(1),a=i(14);e.hudWIdth=320;e.Hud=class extends n.UIContainer{constructor(t){super(),this.resLabels=[],this.player=t;let i=h.getAppSize();this.rect=new l.Rect(i.width-e.hudWIdth,0,e.hudWIdth,i.height);let r=this.rect.pos.clone().add(10,10);for(let e=0;e<a.RES.count;++e){let i=t.getResource(e),o=new s.Label(r,"",i.color,16);this.add(o),r.y+=h.getTextHeight()+2,this.resLabels[e]=o}r.y+=4,this.dynStart=r}assignMap(t){this.map=t}divLine(t){t.y+=4,h.line(t.clone().sub(10,0),t.clone().add(this.rect.size.width,0),"cyan",.5),t.y+=4}drawMiniMap(t){let i,s,r,n,a=this.map.getRoomsInfo();for(let t of a)t.explored&&((void 0===i||t.pos.x<i)&&(i=t.pos.x),(void 0===r||t.pos.y<r)&&(r=t.pos.y),(void 0===s||t.pos.x>s)&&(s=t.pos.x),(void 0===n||t.pos.y>n)&&(n=t.pos.y));let c=30,u=Math.max(s-i+3,n-r+3);c*u>e.hudWIdth&&(c=e.hudWIdth/u);let d=t.x+e.hudWIdth/2-c/2,p=t.y+e.hudWIdth/2-c/2;for(let t=0;t<2;++t)for(let e=0;e<a.length;++e){let u=a[e];if(u.explored||o.isNextToExplored(u,a)){let o=c*(u.pos.x-(s+i)/2),a=c*(u.pos.y-(n+r)/2),f=new l.Rect(d+3+o,p+3+a,c-3,c-3);if(u.explored){let i=this.map.mapPGet(this.player.pos).roomIdx;if(1==t)h.fillrect(f,e==i?"#ffffff":"#aaaaaa");else for(let t of u.doors){let e=new l.Rect(f.sideMiddle(t.dir),new l.Size(6,6));switch(t.dir){case l.DIR.t:e.pos.sub(3,6);break;case l.DIR.b:e.pos.sub(3,0);break;case l.DIR.l:e.pos.sub(6,3);break;case l.DIR.r:e.pos.sub(0,3)}h.fillrect(e,i==t.corrIdx?"#ffffff":"#aaaaaa")}}else h.rect(f,"#999999")}}t.y+=e.hudWIdth}draw(){h.rect(this.rect,"lightgrey",1);let t=this.dynStart.clone();for(let t=0;t<a.RES.count;++t){let e=this.player.getResource(t),i=`${e.descr}: ${e.value}/${e.maxValue}`;this.resLabels[t].label=i}super.draw(),this.divLine(t),this.drawMiniMap(t),this.divLine(t);let e=this.map.mapGet(this.map.mouseMapPos.x,this.map.mouseMapPos.y);if(e&&e.tile&&e.visible){r.TileManager.instance.drawTile(t,e.tileName,e.tileFrame),t.y+=r.tileFullSize,h.textout(t.x,t.y,"white",e.tile.getDescription()),t.y+=h.getTextHeight(),this.divLine(t);for(let i of e.entities){r.TileManager.instance.drawTile(t,i.tileName,i.tileFrame),t.y+=r.tileFullSize;let e=i.getDescription();i.isEnemy&&(e+=` Hp:${i.getHp()}`),h.textout(t.x,t.y,"white",e),t.y+=h.getTextHeight(),this.divLine(t)}}h.textout(this.rect.pos.x,this.rect.pos.y+this.rect.size.height-h.getTextHeight(),"white",`${this.map.mouseMapPos.x},${this.map.mouseMapPos.y}(${e?e.roomIdx:"??"})`)}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(4),r=i(12),o=i(1),n=i(6),h=i(2),l=i(10);class a extends n.UIContainer{constructor(t,e="white",i=32){super();let s=t.split("\n"),n=[],a=0;h.setFontSize(i);for(let t of s){let e=h.getTextSize(t).width;n.push(e),e>a&&(a=e)}{let t=h.getTextSize("Close").width+8;t>a&&(a=t)}let c=i*s.length+8+8+4+i+4;a+=64,this.rect.size.width=a,this.rect.size.height=c,this.rect.pos=h.getAppSize().toPos().sub(this.rect.size.toPos()).div(2);let u=this.rect.pos.clone();u.y+=8;for(let t=0;t<s.length;++t){let r=u.x+(a-n[t])/2,h=u.y,c=new l.Label(new o.Pos(r,h),s[t],e,i);this.add(c),u.y+=i}let d=new r.Button("Close",()=>this.doClose(),{fontSize:i});d.rect.pos.x=u.x+(a-d.rect.size.width)/2,d.rect.pos.y=u.y+8,this.add(d);let p=new r.CloseButton;p.onClose=(()=>this.doClose()),this.add(p),this.bindings.bind("escape",()=>this.doClose())}doClose(){this.onClose&&this.onClose(),this.close()}draw(){h.fillrect(this.rect,"#202020"),h.rect(this.rect,"cyan",1),super.draw()}}e.MessageBox=a,e.showMessageBox=function(t,e="cyan",i=32){let r=new a(t,e,i);return s.uiManager.showModal(r),r}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(16),r=i(4);i(38),r.uiManager.add(new s.MainMenu)},function(t,e,i){var s;!function(r,o,n){if(r){for(var h,l={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},a={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},c={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},u={option:"alt",command:"meta",return:"enter",escape:"esc",plus:"+",mod:/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"meta":"ctrl"},d=1;d<20;++d)l[111+d]="f"+d;for(d=0;d<=9;++d)l[d+96]=d.toString();y.prototype.bind=function(t,e,i){return t=t instanceof Array?t:[t],this._bindMultiple.call(this,t,e,i),this},y.prototype.unbind=function(t,e){return this.bind.call(this,t,function(){},e)},y.prototype.trigger=function(t,e){return this._directMap[t+":"+e]&&this._directMap[t+":"+e]({},t),this},y.prototype.reset=function(){return this._callbacks={},this._directMap={},this},y.prototype.stopCallback=function(t,e){return!((" "+e.className+" ").indexOf(" mousetrap ")>-1)&&(!function t(e,i){return null!==e&&e!==o&&(e===i||t(e.parentNode,i))}(e,this.target)&&("INPUT"==e.tagName||"SELECT"==e.tagName||"TEXTAREA"==e.tagName||e.isContentEditable))},y.prototype.handleKey=function(){return this._handleKey.apply(this,arguments)},y.addKeycodes=function(t){for(var e in t)t.hasOwnProperty(e)&&(l[e]=t[e]);h=null},y.init=function(){var t=y(o);for(var e in t)"_"!==e.charAt(0)&&(y[e]=function(e){return function(){return t[e].apply(t,arguments)}}(e))},y.init(),r.Mousetrap=y,t.exports&&(t.exports=y),void 0===(s=function(){return y}.call(e,i,e,t))||(t.exports=s)}function p(t,e,i){t.addEventListener?t.addEventListener(e,i,!1):t.attachEvent("on"+e,i)}function f(t){if("keypress"==t.type){var e=String.fromCharCode(t.which);return t.shiftKey||(e=e.toLowerCase()),e}return l[t.which]?l[t.which]:a[t.which]?a[t.which]:String.fromCharCode(t.which).toLowerCase()}function g(t){return"shift"==t||"ctrl"==t||"alt"==t||"meta"==t}function _(t,e,i){return i||(i=function(){if(!h)for(var t in h={},l)t>95&&t<112||l.hasOwnProperty(t)&&(h[l[t]]=t);return h}()[t]?"keydown":"keypress"),"keypress"==i&&e.length&&(i="keydown"),i}function m(t,e){var i,s,r,o=[];for(i=function(t){return"+"===t?["+"]:(t=t.replace(/\+{2}/g,"+plus")).split("+")}(t),r=0;r<i.length;++r)s=i[r],u[s]&&(s=u[s]),e&&"keypress"!=e&&c[s]&&(s=c[s],o.push("shift")),g(s)&&o.push(s);return{key:s,modifiers:o,action:e=_(s,o,e)}}function y(t){var e=this;if(t=t||o,!(e instanceof y))return new y(t);e.target=t,e._callbacks={},e._directMap={};var i,s={},r=!1,n=!1,h=!1;function l(t){t=t||{};var e,i=!1;for(e in s)t[e]?i=!0:s[e]=0;i||(h=!1)}function a(t,i,r,o,n,h){var l,a,c,u,d=[],p=r.type;if(!e._callbacks[t])return[];for("keyup"==p&&g(t)&&(i=[t]),l=0;l<e._callbacks[t].length;++l)if(a=e._callbacks[t][l],(o||!a.seq||s[a.seq]==a.level)&&p==a.action&&("keypress"==p&&!r.metaKey&&!r.ctrlKey||(c=i,u=a.modifiers,c.sort().join(",")===u.sort().join(",")))){var f=!o&&a.combo==n,_=o&&a.seq==o&&a.level==h;(f||_)&&e._callbacks[t].splice(l,1),d.push(a)}return d}function c(t,i,s,r){e.stopCallback(i,i.target||i.srcElement,s,r)||!1===t(i,s)&&(function(t){t.preventDefault?t.preventDefault():t.returnValue=!1}(i),function(t){t.stopPropagation?t.stopPropagation():t.cancelBubble=!0}(i))}function u(t){"number"!=typeof t.which&&(t.which=t.keyCode);var i=f(t);i&&("keyup"!=t.type||r!==i?e.handleKey(i,function(t){var e=[];return t.shiftKey&&e.push("shift"),t.altKey&&e.push("alt"),t.ctrlKey&&e.push("ctrl"),t.metaKey&&e.push("meta"),e}(t),t):r=!1)}function d(t,e,o,n){function a(e){return function(){h=e,++s[t],clearTimeout(i),i=setTimeout(l,1e3)}}function u(e){c(o,e,t),"keyup"!==n&&(r=f(e)),setTimeout(l,10)}s[t]=0;for(var d=0;d<e.length;++d){var p=d+1===e.length?u:a(n||m(e[d+1]).action);_(e[d],p,n,t,d)}}function _(t,i,s,r,o){e._directMap[t+":"+s]=i;var n,h=(t=t.replace(/\s+/g," ")).split(" ");h.length>1?d(t,h,i,s):(n=m(t,s),e._callbacks[n.key]=e._callbacks[n.key]||[],a(n.key,n.modifiers,{type:n.action},r,t,o),e._callbacks[n.key][r?"unshift":"push"]({callback:i,modifiers:n.modifiers,action:n.action,seq:r,level:o,combo:t}))}e._handleKey=function(t,e,i){var s,r=a(t,e,i),o={},u=0,d=!1;for(s=0;s<r.length;++s)r[s].seq&&(u=Math.max(u,r[s].level));for(s=0;s<r.length;++s)if(r[s].seq){if(r[s].level!=u)continue;d=!0,o[r[s].seq]=1,c(r[s].callback,i,r[s].combo,r[s].seq)}else d||c(r[s].callback,i,r[s].combo);var p="keypress"==i.type&&n;i.type!=h||g(t)||p||l(o),n=d&&"keydown"==i.type},e._bindMultiple=function(t,e,i){for(var s=0;s<t.length;++s)_(t[s],e,i)},p(t,"keypress",u),p(t,"keydown",u),p(t,"keyup",u)}}("undefined"!=typeof window?window:null,"undefined"!=typeof window?document:null)},function(t,e){!function(t){var e=t.prototype.stopCallback;t.prototype.stopCallback=function(t,i,s){return!!this.paused||e.call(this,t,i,s)},t.prototype.pause=function(){this.paused=!0},t.prototype.unpause=function(){this.paused=!1},t.init()}(Mousetrap)},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(6),r=i(12),o=i(5),n=i(1),h=i(4),l=i(28),a=i(2),c=i(10),u=["Idle Character is the most powerful when standing still.\nWhy rush toward the enemy if enemy can come to you.","Impulse Character is all about fast movement and\ntransfer of his impulse into the pain of his enemies.","Impact Character's attacks are so hard that they stun\nhis enemies making them unable to counter-attack."];class d extends r.Button{constructor(t,e,i,s){super(e,i,s),this.tile=t,this.rect.size.width+=o.tileSize+4,this.tilePos=this.labelPos.clone(),this.labelPos.x+=o.tileSize+4}onMouseEnter(t){super.onMouseEnter(t),this.onStartHover&&this.onStartHover()}onMouseLeave(t){super.onMouseLeave(t),this.onEndHover&&this.onEndHover()}draw(){super.draw();let t=this.rect.pos.clone().add(this.tilePos);o.TileManager.instance.drawTile(t,this.tile)}}e.CharSelector=class extends s.UIContainer{constructor(){super(),this.buttons=[];let t={minWidth:320,minHeight:64};this.buttons.push(new d("player-1","Idle",()=>this.selectIdle(),t)),this.buttons.push(new d("player-2","Impulse",()=>this.selectImpulse(),t)),this.buttons.push(new d("player-3","Impact",()=>this.selectImpact(),t));let e=this.buttons.reduce((t,e)=>t.rect.size.width>e.rect.size.width?t:e).rect.size.width,i=this.buttons[0].rect.size.height,s=a.getAppRect(),r=new c.Label(new n.Pos,"Select your character","white",48);r.rect.pos.x=s.size.width/2-r.rect.size.width/2,this.add(r);let o=s.size.toPos().div(2).sub(e/2,(i*this.buttons.length+8*(this.buttons.length-1))/2);for(let t=0;t<this.buttons.length;++t){let e=this.buttons[t];e.rect.pos=o.clone(),this.add(e),e.onStartHover=(()=>this.setDescr(u[t])),e.onEndHover=(()=>this.clearDescr()),o.y+=e.rect.size.height+8}this.descr=new c.Label(new n.Pos(s.size.width/2,o.y+100),""),this.add(this.descr)}selectIdle(){this.close(),h.uiManager.add(new l.Game(1))}selectImpulse(){this.close(),h.uiManager.add(new l.Game(2))}selectImpact(){this.close(),h.uiManager.add(new l.Game(3))}setDescr(t){this.descr.setLabel(t),this.descr.centerX()}clearDescr(){this.descr.setLabel("")}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(18),r=i(6),o=i(33),n=i(22),h=i(34);e.Game=class extends r.UIContainer{constructor(t){super(),this.depth=1,this.player=new o.Player(t),this.hud=new n.Hud(this.player),this.add(this.hud),this.nextLevel()}nextLevel(){this.currentLevel=new h.Level(this),new s.RoomsGenerator(this.depth).generate(this.currentLevel),this.currentLevel.addPlayer(this.player),this.add(this.currentLevel),this.hud.assignMap(this.currentLevel),++this.depth}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(2);e.FloatingTextAni=class{constructor(t,e,i,s,r=10){this.txt=t,this.clr=e,this.pos=i.clone(),this.dir=s.clone(),this.steps=r}nextFrame(){return!(--this.steps<=0||(s.setFontSize(16),s.textoutex(this.pos.x,this.pos.y,this.clr,this.txt,"back",4),this.pos.add(this.dir),0))}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(31),r=i(5),o=i(9),n=i(4),h=i(13),l=i(32);class a extends h.Entity{constructor(){super(...arguments),this.hp=100,this.stunTurns=0,this.isEnemy=!0}onTurn(){this.stunTurns>0?(--this.stunTurns,0==this.stunTurns&&this.cancelEffect("stun")):this.ai.think(this)}animate(){n.uiManager.addAnimation(new o.FwdAndBackAnimation(t=>this.onFrame(t),r.TileManager.instance.getTileFrames(this.tileName)-1))}receiveDamage(t,e){t>0&&this.startFloatingText(t.toString(),"red",e?e.pos:this.pos.clone().add(-1,1)),this.hp-=t,this.hp<=0&&(this.alive=!1)}getHp(){return this.hp}stun(t){t>this.stunTurns&&(this.stunTurns=t),this.stunTurns>0&&(this.hasEffect("stun")||this.addEffect(new l.Effect("stun","stun-effect")))}}e.Muncher=class extends a{constructor(){super(),this.ai=new s.AgressiveMeleeAI,this.tileName="muncher",this.animate()}getDamage(){return 10}getDescription(){return"Muncher"}};e.Spyware=class extends a{constructor(){super(),this.ai=new s.FleeingAI,this.tileName="spyware",this.animate()}getDescription(){return"Spyware"}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(1);e.AgressiveMeleeAI=class{think(t){let e=t.pos,i=t.map.getPlayer(),r=i.pos;if(1==e.manhattanDistanceTo(r))i.receiveDamage(t.getDamage(),t);else{let i=t.map.calcPath(e,r);i.length>1&&t.move(s.diffToDir(t.pos.x,t.pos.y,i[1].x,i[1].y))}}};e.FleeingAI=class{think(t){let e=t.pos.makeRectAround(10),i=[];console.log(`my pos ${t.pos.x},${t.pos.y}`);for(let s=e.getIterator();s.next();){let e=t.map.mapPGet(s.value);e&&e.hasEntities()&&(i.push(s.value.clone()),console.log(`danger source ${s.value.x},${s.value.y}`))}i.length&&t.map.floodMap(i,10)}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.Effect=class{constructor(t,e,i){this.id=t,this.tileName=e,this.tint=i,this.frame=0}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(14),r=i(13),o=i(17),n=i(21);e.Player=class extends r.Entity{constructor(t){super(),this.isPlayer=!0,this.resources=[new s.Resource("Health","green"),new s.Resource("Shield","lightblue"),new s.Resource("Idle",o.idleColor),new s.Resource("Impulse",o.impulseColor),new s.Resource("Impact",o.impactColor)],this.abilities=[],this.damageReceived=0,this.stunStrength=0,this.type=t,this.tileName="player-"+t,this.resources[s.RES.health].setMaxValue(100),this.resources[s.RES.shield].setMaxValue(1==t?30:0),this.resources[s.RES.idleCharge].maxValue=3,this.resources[s.RES.impactCharge].maxValue=3,this.resources[s.RES.impulseCharge].maxValue=3,1==t?this.abilities.push(new n.ShieldRecharge):2==t?this.abilities.push(new n.JumpKick):3==t&&(this.stunStrength=2,this.abilities.push(new n.StunningSmash))}getResource(t){return this.resources[t]}getDescription(){return"Player"}getDamage(){return 25}getStunStrength(){return this.stunStrength}receiveDamage(t,e){let i=e?e.pos:this.pos.clone().add(-1,1);if(this.resources[s.RES.shield].value>0){let e=t-(t=this.resources[s.RES.shield].sub(t));this.startFloatingText(e.toString(),"lightblue",i)}t>0&&this.startFloatingText(t.toString(),"green",i),this.resources[s.RES.health].value-=t,this.resources[s.RES.health].value<=0&&(this.alive=!1),this.damageReceived=2}shieldRegen(){this.damageReceived?--this.damageReceived:this.resources[s.RES.shield].add(5)}onMove(){this.resources[s.RES.idleCharge].sub(1),this.resources[s.RES.impulseCharge].add(1),this.resources[s.RES.impactCharge].sub(1),this.shieldRegen()}onAttack(){this.resources[s.RES.idleCharge].sub(1),this.resources[s.RES.impulseCharge].sub(1),this.resources[s.RES.impactCharge].add(1)}onPassTurn(){this.resources[s.RES.idleCharge].add(1),this.resources[s.RES.impulseCharge].sub(1),this.resources[s.RES.impactCharge].sub(1),this.shieldRegen()}getAbilitties(){return this.abilities}spendAbilityCose(t){for(let e of t.getCost())this.getResource(e.res).sub(e.amount)}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(4),r=i(19),o=i(5),n=i(22),h=i(8),l=i(2),a=i(1),c=i(35),u=i(23),d=i(16),p=i(20),f=i(37),g=i(21);class _{constructor(t){this.callback=t}nextFrame(){return this.callback()}}const m=[["up","w"],["down","s"],["left","a"],["right","d"]],y=["dir-up","dir-down","dir-left","dir-right"];class b extends h.UIBase{constructor(t,e,i){super(),this.map=t,this.pos=e,this.onSelect=i,this.off=0,this.offDir=1,this.onClick=(t=>{let e=new a.Pos(t.x,t.y),i=this.map.mapToScreen(this.pos);for(let t=0;t<4;++t){if(new a.Rect(i.clone().add(a.dirX[t]*o.tileSize,a.dirY[t]*o.tileSize),new a.Size(o.tileSize,o.tileSize)).isInside(e))return this.close(),void this.onSelect(t)}})}onAdd(){for(let t=0;t<4;++t)this.bindings.bind(m[t],()=>this.onPress(t));this.bindings.bind("escape",()=>this.close())}onPress(t){this.close(),this.onSelect(t)}draw(){let t=this.map.mapToScreen(this.pos);for(let e=0;e<4;++e){let i=t.clone().add(a.dirX[e]*(o.tileSize+this.off),a.dirY[e]*(o.tileSize+this.off));o.TileManager.instance.drawTile(i,y[e])}this.off+=this.offDir,(this.off<=-5||this.off>=5)&&(this.offDir=-this.offDir)}}e.Level=class extends h.UIBase{constructor(t){super(),this.playerActions=t,this.offset=new a.Pos,this.dragStart=null,this.offsetStart=null,this.mapRect=new a.Rect,this.map={},this.mouseMapPos=new a.Pos,this.debugTiles=!1,this.activeConn=0,this.conns=[],this.connNodes=[],this.markerFrame=0,this.lastPathSrc=new a.Pos,this.lastPathPos=new a.Pos,this.lastPath=[],this.mouseMoved=!1,this.centerAni=new _(()=>this.centerStep()),this.centering=!1,this.visAni=new _(()=>this.visStep()),this.visTiles=[],this.entities=[],this.blockedDoors=[],this.floodSeq=0,this.showFlood=!1,this.runIdx=0,this.runMode=!1,this.runModeDir=!1,this.onClick=(t=>{if(this.lastPath.length)if(0==t.original.button){let t=this.player.pos,e=this.lastPath[1],i=a.diffToDir(t.x,t.y,e.x,e.y);this.move(i,!0),this.lastPathPos.assign(t),this.updatePath()}else 2==t.original.button&&(this.mouseMapPos.isEqual(this.player.pos)?this.showAbilities():(this.runIdx=1,this.runMode=!0,this.runModeStep()));else 2==t.original.button&&this.mouseMapPos.isEqual(this.player.pos)&&this.showAbilities()});let e=l.getAppSize();this.rect=new a.Rect(0,0,e.width-n.hudWIdth,e.height)}setRoomsInfo(t){this.rooms=t}getRoomsInfo(){return this.rooms}onAdd(){for(let t=0;t<4;++t){this.bindings.bind(m[t],()=>this.move(t));for(let e of m[t])this.bindings.bind("shift+"+e,()=>this.runInDir(t))}this.bindings.bind("space",()=>this.passTurn()),this.bindings.bind("q",()=>this.toggleDebugTiles()),this.bindings.bind("f",()=>this.showFlood=!this.showFlood),this.bindings.bind("escape",()=>this.cancelRunMode()),this.bindings.bind("shift+c",()=>this.centerPlayer()),this.bindings.bind("c",()=>this.showAbilities())}toggleDebugTiles(){this.debugTiles=!this.debugTiles}setEntrance(t){this.entrance=t.clone()}addPlayer(t){t.map=this,this.player=t,this.player.pos=this.entrance.clone(),this.mapPGet(this.player.pos).addEntity(this.player),this.centerPlayer(),this.startVisAni(t.pos)}centerToPos(t){this.centering||(this.centering=!0,this.centerPos=t,s.uiManager.addAnimation(this.centerAni))}centerPlayer(){this.centerToPos(this.player.pos)}centerStep(){let t=this.mapToScreen(this.centerPos),e=this.rect.middle().sub(t),i=e.length();return i<o.tileSize?(this.centering=!1,!1):(e.div(i).mul(2*o.tileSize),this.offset.sub(e),this.centering)}startVisAni(t){this.visTiles.push(t.clone());let e=this.mapPGet(t);e&&(this.visRoomId=e.roomIdx,e.roomIdx<this.rooms.length&&(console.log(`start vis for room ${e.roomIdx}`),this.rooms[e.roomIdx].explored=!0)),s.uiManager.addAnimation(this.visAni)}visStep(){if(0==this.visTiles.length)return console.log("vis finished"),!1;let t={},e=[];for(let i of this.visTiles){let s=this.mapPGet(i);if(s&&!s.visible){s.visible=!0;for(let r=0;r<4;++r){let o=i.clone().add(a.dirX[r],a.dirY[r]),n=o.id();t[n]||(t[n]=!0,!(s=this.mapPGet(o))||s.visible||s.roomIdx!=this.visRoomId&&!s.alwaysVis||e.push(o))}}}return this.visTiles=e,this.visTiles.length>0}onPlayerAction(){if(this.entities=this.entities.filter(t=>(t.alive&&t.onTurn(),t.alive||this.mapPGet(t.pos).removeEntity(t),t.alive)),0==this.entities.length){for(let t of this.blockedDoors)t.unblock();this.blockedDoors=[]}this.player.alive||(this.cancelRunMode(),u.showMessageBox("Game Over","red").onClose=(()=>this.doClose()))}doClose(){this.parent.close(),s.uiManager.add(new d.MainMenu)}getPlayer(){return this.player}interactWith(t){return t.isEnemy?(this.player.onAttack(),t.receiveDamage(this.player.getDamage(),this.player),t.stun(this.player.getStunStrength()),t.alive||this.mapPGet(t.pos).removeEntity(t),!0):t.interactWith()}isCloseToBorder(t){(t=this.mapToScreen(t)).add(o.tileSize/2,o.tileSize/2);let e=this.rect.clone(),i=new a.Pos(2*o.tileSize,2*o.tileSize),s=e.bottomRight();return e.pos.add(i),s.sub(i),e.bottomRight(s),!e.isInside(t)}exploreRoom(t){if(this.startVisAni(new a.Pos(this.player.pos.x,this.player.pos.y)),t>=this.rooms.length)return;let e=this.rooms[t];this.centerToPos(e.mrect.middle());let i=[];for(let t=e.mrect.getIterator();t.next();){let e=this.mapPGet(t.value);if(e)for(let t of e.entities)t.isEnemy?(t.map=this,this.entities.push(t)):t instanceof p.Door&&i.push(t)}if(this.entities.length){for(let t of i)t.block();this.blockedDoors=i}}runInDir(t){this.runMode=!0,this.runModeDir=!0,this.runDir=t,this.runModeStep()}move(t,e=!1){e||(this.runMode=!1,this.resetLastPath());let i=a.dirX[t],s=a.dirY[t],o=this.mapGet(this.player.pos.x+i,this.player.pos.y+s);if(o&&o.passable){if(o.hasBlockingEntity()&&this.interactWith(o.getBlockingEntity()))return void this.onPlayerAction();this.player.move(t),o.visible||this.exploreRoom(o.roomIdx),this.isCloseToBorder(this.player.pos)&&this.centerPlayer(),o.tile instanceof r.StairsDownTile?(this.close(),this.playerActions.nextLevel()):this.onPlayerAction()}}passTurn(){this.player.onPassTurn(),this.onPlayerAction()}addEntity(t,e){return e.map=this,this.mapGet(t.x,t.y).addEntity(e),!0}mapClear(t){let e=t.x+"x"+t.y;delete this.map[e]}mapPSet(t,e){return this.mapSet(t.x,t.y,e)}mapSet(t,e,i){let s=(t|=0)+"x"+(e|=0),o=new r.TileInfo(i);o.pos=new a.Pos(t,e),this.map[s]=o;let n=this.mapRect.pos.x,h=this.mapRect.pos.y,l=!1;t<n&&(n=t,l=!0),e<h&&(h=e,l=!0),l&&this.mapRect.setTopLeft(new a.Pos(n,h));let c=this.mapRect.bottomRight(),u=!1;return t+1>c.x&&(u=!0,c.x=t+1),e+1>c.y&&(c.y=e+1,u=!0),u&&this.mapRect.bottomRight(c),o}mapGet(t,e){let i=(t|=0)+"x"+(e|=0);return this.map[i]}mapPGet(t){let e=t.x,i=t.y,s=(e|=0)+"x"+(i|=0);return this.map[s]}mapToScreen(t){return t.clone().mul(o.tileSize).sub(this.offset)}draw(){if(this.runMode&&this.runModeStep(),this.debugTiles){let t=l.getCtx(),e=o.TileManager.instance.cacheCanvas;return t.drawImage(e,0,0,e.width,e.height,0,0,e.width,e.height),t.fillStyle="rgba(255,255,255,0.3)",void t.fillRect(this.mouseMapPos.x*o.tileFullSize,this.mouseMapPos.y*o.tileFullSize,o.tileFullSize,o.tileFullSize)}const t=Math.ceil(this.rect.size.width/o.tileSize)+1,e=Math.ceil(this.rect.size.height/o.tileSize)+1;l.setClip(this.rect);let i=this.offset.clone(),s=Math.floor(i.x/o.tileSize),r=Math.floor(i.y/o.tileSize);i.x=-(i.x%o.tileSize+o.tileSize)%o.tileSize,i.y=-(i.y%o.tileSize+o.tileSize)%o.tileSize;let n=i.clone();for(let h=0;h<e;++h){for(let e=0;e<t;++e){let t=this.mapGet(s+e,r+h);if(t&&t.visible){t.tintColor?o.TileManager.instance.drawTileTinted(i,t.tileName,t.tintColor,t.tileFrame):o.TileManager.instance.drawTile(i,t.tileName,t.tileFrame);for(let e of t.entities)o.TileManager.instance.drawTile(i,e.tileName,e.tileFrame);for(let e of t.entities)for(let t of e.effects)o.TileManager.instance.drawTile(i,t.tileName,t.frame),++t.frame;this.showFlood&&t.floodSeq==this.floodSeq&&(l.setFontSize(8),l.textout(i.x,i.y,"white",t.floodValue.toString()))}s+e==this.mouseMapPos.x&&r+h==this.mouseMapPos.y&&o.TileManager.instance.drawTile(i,"tile-highlight",0),i.x+=o.tileSize}n.y+=o.tileSize,i.assign(n)}l.resetClip()}resetLastPath(){for(let t of this.lastPath)this.mapGet(t.x,t.y).tintColor=void 0;this.lastPath=[]}addToPath(t,e){this.lastPath.push(new a.Pos(t,e))}updatePath(){if(this.lastPathPos.isEqual(this.mouseMapPos))return;if(!this.mapPGet(this.mouseMapPos))return;this.resetLastPath();let t=this.player.pos;if(this.lastPathSrc.assign(t),this.lastPathPos.assign(this.mouseMapPos),!t.isEqual(this.lastPathPos)){new c.default.Path.AStar(this.lastPathPos.x,this.lastPathPos.y,(t,e)=>this.passabilityTest(t,e,this.lastPathSrc),{topology:4}).compute(t.x,t.y,(t,e)=>this.addToPath(t,e));for(let t of this.lastPath)this.mapGet(t.x,t.y).tintColor="cyan";this.runMode&&(this.runIdx=1)}}calcPath(t,e){let i=[];return new c.default.Path.AStar(e.x,e.y,(e,i)=>this.passabilityTest(e,i,t),{topology:4}).compute(t.x,t.y,(t,e)=>i.push(new a.Pos(t,e))),i}passabilityTest(t,e,i){if(i.x==t&&i.y==e)return!0;let s=this.mapGet(t,e);return s&&s.passable&&!s.hasBlockingEntity()}onMouseDown(t){this.dragStart=new a.Pos(t.x,t.y),this.offsetStart=this.offset.clone(),this.mouseMoved=!1,this.updateMapMousePos(t),this.centering=!1}onMouseUp(t){this.dragStart=null,this.mouseMoved||this.onClick(t)}updateMapMousePos(t){this.debugTiles?(this.mouseMapPos.x=Math.floor(t.x/o.tileFullSize),this.mouseMapPos.y=Math.floor(t.y/o.tileFullSize)):(this.mouseMapPos.x=Math.floor((this.offset.x+t.x)/o.tileSize),this.mouseMapPos.y=Math.floor((this.offset.y+t.y)/o.tileSize),this.updatePath())}onMouseMove(t){if(this.mouseMoved=!0,this.dragStart){this.offset.x=this.offsetStart.x+(this.dragStart.x-t.x),this.offset.y=this.offsetStart.y+(this.dragStart.y-t.y);let e=this.mapRect.pos.clone().mul(o.tileSize).sub(this.rect.size.toPos().div(2)),i=this.mapRect.size.toPos().mul(o.tileSize).toSize();this.offset.clamp(new a.Rect(e,i))}this.updateMapMousePos(t)}runModeStep(){if(this.runModeDir){let t=this.player.pos.clone().addDir(this.runDir),e=this.mapPGet(t);e.passable&&!e.hasBlockingEntity()?this.move(this.runDir,!0):this.cancelRunMode()}else{if(this.runIdx>=this.lastPath.length)return void this.cancelRunMode();let t=this.player.pos,e=this.lastPath[this.runIdx],i=a.diffToDir(t.x,t.y,e.x,e.y);this.move(i,!0),++this.runIdx}}cancelRunMode(){this.runMode=!1,this.runModeDir=!1,this.resetLastPath()}floodMap(t,e=-1){let i=0,s=[];for(new a.Pos,++this.floodSeq;t.length;){for(let e of t){let t=this.mapPGet(e);console.log(`check ${t} at ${e.x},${e.y}`),t.floodSeq=this.floodSeq,t.floodValue=i;for(let i=0;i<4;++i){let r=e.x+a.dirX[i],o=e.y+a.dirY[i],n=this.mapGet(r,o);n&&n.passable&&n.floodSeq!=this.floodSeq&&t.conn[a.diffToDir(e.x,e.y,r,o)]&&s.push(new a.Pos(r,o))}}if(++i,t=s,s=[],-1!=e&&i>e)break}}activatePendingDirAbility(t){let e=new g.AbilityTarget;e.dir=t,this.pendingAbility.activate(this.player,e),this.player.spendAbilityCose(this.pendingAbility),this.onPlayerAction()}activateAbility(t){t.getTargetType()==g.AbilityTargetType.none?(t.activate(this.player),this.player.spendAbilityCose(t),this.onPlayerAction()):t.getTargetType()==g.AbilityTargetType.direction&&(this.pendingAbility=t,s.uiManager.showModal(new b(this,this.player.pos,t=>this.activatePendingDirAbility(t))))}showAbilities(){console.log("show abil"),s.uiManager.showModal(new f.AbilityList(this.player,t=>this.activateAbility(t)))}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(43);e.default=s},function(t,e){var i,s,r=t.exports={};function o(){throw new Error("setTimeout has not been defined")}function n(){throw new Error("clearTimeout has not been defined")}function h(t){if(i===setTimeout)return setTimeout(t,0);if((i===o||!i)&&setTimeout)return i=setTimeout,setTimeout(t,0);try{return i(t,0)}catch(e){try{return i.call(null,t,0)}catch(e){return i.call(this,t,0)}}}!function(){try{i="function"==typeof setTimeout?setTimeout:o}catch(t){i=o}try{s="function"==typeof clearTimeout?clearTimeout:n}catch(t){s=n}}();var l,a=[],c=!1,u=-1;function d(){c&&l&&(c=!1,l.length?a=l.concat(a):u=-1,a.length&&p())}function p(){if(!c){var t=h(d);c=!0;for(var e=a.length;e;){for(l=a,a=[];++u<e;)l&&l[u].run();u=-1,e=a.length}l=null,c=!1,function(t){if(s===clearTimeout)return clearTimeout(t);if((s===n||!s)&&clearTimeout)return s=clearTimeout,clearTimeout(t);try{s(t)}catch(e){try{return s.call(null,t)}catch(e){return s.call(this,t)}}}(t)}}function f(t,e){this.fun=t,this.array=e}function g(){}r.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)e[i-1]=arguments[i];a.push(new f(t,e)),1!==a.length||c||h(p)},f.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=g,r.addListener=g,r.once=g,r.off=g,r.removeListener=g,r.removeAllListeners=g,r.emit=g,r.prependListener=g,r.prependOnceListener=g,r.listeners=function(t){return[]},r.binding=function(t){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(t){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(6),r=i(1),o=i(2),n=i(10),h=new r.Size(300,100),l=20,a=16;class c extends s.UIContainer{constructor(t,e,i){super(),this.rect.pos.assign(t),this.rect.size.assign(h);let s=new n.Label(t.add(10,10),e,i,a);this.add(s),this.costsPos=s.rect.pos.clone().add(0,s.rect.size.height+a/4)}addCost(t,e){let i=new n.Label(this.costsPos,t,e,a);this.add(i),this.costsPos.add(i.rect.size.width,0)}draw(){o.fillrect(this.rect,this.mouseOver?"rgba(100, 100, 100, 0.6":"rgba(0, 0, 0, 0.5"),o.rect(this.rect,this.mouseOver?"#BBBBBB":"#999999",2),super.draw()}}e.AbilityPlate=c;e.AbilityList=class extends s.UIContainer{constructor(t,e){super(),this.player=t,this.onActivate=e}activate(t){this.close(),this.onActivate(t)}onAdd(){let t=new r.Rect(0,0,4,4).getIterator();t.next();let e=h.width+l,i=h.height+l,s=new r.Pos;s.x=this.parent.rect.size.width/2-4*e/2,s.y=this.parent.rect.size.height/2-4*i/2;let o=1;for(let r of this.player.getAbilitties()){let n=r.getCost().every(t=>this.player.getResource(t.res).value>=t.amount),h=s.clone().add(t.value.x*e,t.value.y*i),l=new c(h,r.getName(),n?"white":"lightgrey"),a=r.getCost();for(let t of a)l.addCost(t.amount.toString(),this.player.getResource(t.res).color);n&&(l.onClick=(()=>this.activate(r)),this.bindings.bind(o.toString(),()=>this.activate(r))),this.add(l),t.next(),++o}this.bindings.bind("escape",()=>this.close()),this.onClick=(t=>{2==t.original.button&&this.close()})}}},function(t,e,i){var s=i(39);"string"==typeof s&&(s=[[t.i,s,""]]);var r={hmr:!0,transform:void 0,insertInto:void 0};i(41)(s,r);s.locals&&(t.exports=s.locals)},function(t,e,i){(t.exports=i(40)(!1)).push([t.i,"body{\n    background: black;\n    height:100vh;\n    padding: 0;\n    margin: 0;\n    overflow: hidden;\n}\ncanvas {\n    position: absolute;\n    top:0;\n    left:0;\n    transform-origin: top left;\n}\n",""])},function(t,e,i){"use strict";t.exports=function(t){var e=[];return e.toString=function(){return this.map(function(e){var i=function(t,e){var i=t[1]||"",s=t[3];if(!s)return i;if(e&&"function"==typeof btoa){var r=(n=s,"/*# sourceMappingURL=data:application/json;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(n))))+" */"),o=s.sources.map(function(t){return"/*# sourceURL="+s.sourceRoot+t+" */"});return[i].concat(o).concat([r]).join("\n")}var n;return[i].join("\n")}(e,t);return e[2]?"@media "+e[2]+"{"+i+"}":i}).join("")},e.i=function(t,i){"string"==typeof t&&(t=[[null,t,""]]);for(var s={},r=0;r<this.length;r++){var o=this[r][0];null!=o&&(s[o]=!0)}for(r=0;r<t.length;r++){var n=t[r];null!=n[0]&&s[n[0]]||(i&&!n[2]?n[2]=i:i&&(n[2]="("+n[2]+") and ("+i+")"),e.push(n))}},e}},function(t,e,i){var s,r,o={},n=(s=function(){return window&&document&&document.all&&!window.atob},function(){return void 0===r&&(r=s.apply(this,arguments)),r}),h=function(t){var e={};return function(t,i){if("function"==typeof t)return t();if(void 0===e[t]){var s=function(t,e){return e?e.querySelector(t):document.querySelector(t)}.call(this,t,i);if(window.HTMLIFrameElement&&s instanceof window.HTMLIFrameElement)try{s=s.contentDocument.head}catch(t){s=null}e[t]=s}return e[t]}}(),l=null,a=0,c=[],u=i(42);function d(t,e){for(var i=0;i<t.length;i++){var s=t[i],r=o[s.id];if(r){r.refs++;for(var n=0;n<r.parts.length;n++)r.parts[n](s.parts[n]);for(;n<s.parts.length;n++)r.parts.push(y(s.parts[n],e))}else{var h=[];for(n=0;n<s.parts.length;n++)h.push(y(s.parts[n],e));o[s.id]={id:s.id,refs:1,parts:h}}}}function p(t,e){for(var i=[],s={},r=0;r<t.length;r++){var o=t[r],n=e.base?o[0]+e.base:o[0],h={css:o[1],media:o[2],sourceMap:o[3]};s[n]?s[n].parts.push(h):i.push(s[n]={id:n,parts:[h]})}return i}function f(t,e){var i=h(t.insertInto);if(!i)throw new Error("Couldn't find a style target. This probably means that the value for the 'insertInto' parameter is invalid.");var s=c[c.length-1];if("top"===t.insertAt)s?s.nextSibling?i.insertBefore(e,s.nextSibling):i.appendChild(e):i.insertBefore(e,i.firstChild),c.push(e);else if("bottom"===t.insertAt)i.appendChild(e);else{if("object"!=typeof t.insertAt||!t.insertAt.before)throw new Error("[Style Loader]\n\n Invalid value for parameter 'insertAt' ('options.insertAt') found.\n Must be 'top', 'bottom', or Object.\n (https://github.com/webpack-contrib/style-loader#insertat)\n");var r=h(t.insertAt.before,i);i.insertBefore(e,r)}}function g(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t);var e=c.indexOf(t);e>=0&&c.splice(e,1)}function _(t){var e=document.createElement("style");if(void 0===t.attrs.type&&(t.attrs.type="text/css"),void 0===t.attrs.nonce){var s=function(){0;return i.nc}();s&&(t.attrs.nonce=s)}return m(e,t.attrs),f(t,e),e}function m(t,e){Object.keys(e).forEach(function(i){t.setAttribute(i,e[i])})}function y(t,e){var i,s,r,o;if(e.transform&&t.css){if(!(o="function"==typeof e.transform?e.transform(t.css):e.transform.default(t.css)))return function(){};t.css=o}if(e.singleton){var n=a++;i=l||(l=_(e)),s=x.bind(null,i,n,!1),r=x.bind(null,i,n,!0)}else t.sourceMap&&"function"==typeof URL&&"function"==typeof URL.createObjectURL&&"function"==typeof URL.revokeObjectURL&&"function"==typeof Blob&&"function"==typeof btoa?(i=function(t){var e=document.createElement("link");return void 0===t.attrs.type&&(t.attrs.type="text/css"),t.attrs.rel="stylesheet",m(e,t.attrs),f(t,e),e}(e),s=function(t,e,i){var s=i.css,r=i.sourceMap,o=void 0===e.convertToAbsoluteUrls&&r;(e.convertToAbsoluteUrls||o)&&(s=u(s));r&&(s+="\n/*# sourceMappingURL=data:application/json;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(r))))+" */");var n=new Blob([s],{type:"text/css"}),h=t.href;t.href=URL.createObjectURL(n),h&&URL.revokeObjectURL(h)}.bind(null,i,e),r=function(){g(i),i.href&&URL.revokeObjectURL(i.href)}):(i=_(e),s=function(t,e){var i=e.css,s=e.media;s&&t.setAttribute("media",s);if(t.styleSheet)t.styleSheet.cssText=i;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(i))}}.bind(null,i),r=function(){g(i)});return s(t),function(e){if(e){if(e.css===t.css&&e.media===t.media&&e.sourceMap===t.sourceMap)return;s(t=e)}else r()}}t.exports=function(t,e){if("undefined"!=typeof DEBUG&&DEBUG&&"object"!=typeof document)throw new Error("The style-loader cannot be used in a non-browser environment");(e=e||{}).attrs="object"==typeof e.attrs?e.attrs:{},e.singleton||"boolean"==typeof e.singleton||(e.singleton=n()),e.insertInto||(e.insertInto="head"),e.insertAt||(e.insertAt="bottom");var i=p(t,e);return d(i,e),function(t){for(var s=[],r=0;r<i.length;r++){var n=i[r];(h=o[n.id]).refs--,s.push(h)}t&&d(p(t,e),e);for(r=0;r<s.length;r++){var h;if(0===(h=s[r]).refs){for(var l=0;l<h.parts.length;l++)h.parts[l]();delete o[h.id]}}}};var b,w=(b=[],function(t,e){return b[t]=e,b.filter(Boolean).join("\n")});function x(t,e,i,s){var r=i?"":s.css;if(t.styleSheet)t.styleSheet.cssText=w(e,r);else{var o=document.createTextNode(r),n=t.childNodes;n[e]&&t.removeChild(n[e]),n.length?t.insertBefore(o,n[e]):t.appendChild(o)}}},function(t,e){t.exports=function(t){var e="undefined"!=typeof window&&window.location;if(!e)throw new Error("fixUrls requires window.location");if(!t||"string"!=typeof t)return t;var i=e.protocol+"//"+e.host,s=i+e.pathname.replace(/\/[^\/]*$/,"/");return t.replace(/url\s*\(((?:[^)(]|\((?:[^)(]+|\([^)(]*\))*\))*)\)/gi,function(t,e){var r,o=e.trim().replace(/^"(.*)"$/,function(t,e){return e}).replace(/^'(.*)'$/,function(t,e){return e});return/^(#|data:|http:\/\/|https:\/\/|file:\/\/\/|\s*$)/i.test(o)?t:(r=0===o.indexOf("//")?o:0===o.indexOf("/")?i+o:s+o.replace(/^\.\//,""),"url("+JSON.stringify(r)+")")})}},function(t,e,i){"use strict";i.r(e);var s={};i.r(s),i.d(s,"TYPE_TEXT",function(){return p}),i.d(s,"TYPE_NEWLINE",function(){return f}),i.d(s,"TYPE_FG",function(){return g}),i.d(s,"TYPE_BG",function(){return _}),i.d(s,"measure",function(){return m}),i.d(s,"tokenize",function(){return y});var r=i(0),o=i(11);class n extends o.a{constructor(){super(),this._ctx=document.createElement("canvas").getContext("2d")}schedule(t){requestAnimationFrame(t)}getContainer(){return this._ctx.canvas}setOptions(t){super.setOptions(t);const e=`${t.fontStyle?`${t.fontStyle} `:""} ${t.fontSize}px ${t.fontFamily}`;this._ctx.font=e,this._updateSize(),this._ctx.font=e,this._ctx.textAlign="center",this._ctx.textBaseline="middle"}clear(){this._ctx.fillStyle=this._options.bg,this._ctx.fillRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height)}eventToPosition(t,e){let i=this._ctx.canvas,s=i.getBoundingClientRect();return t-=s.left,e-=s.top,t*=i.width/s.width,e*=i.height/s.height,t<0||e<0||t>=i.width||e>=i.height?[-1,-1]:this._normalizedEventToPosition(t,e)}}var h=i(3);class l extends n{constructor(){super(),this._spacingX=0,this._spacingY=0,this._hexSize=0}draw(t,e){let[i,s,r,o,n]=t,h=[(i+1)*this._spacingX,s*this._spacingY+this._hexSize];if(this._options.transpose&&h.reverse(),e&&(this._ctx.fillStyle=n,this._fill(h[0],h[1])),!r)return;this._ctx.fillStyle=o;let l=[].concat(r);for(let t=0;t<l.length;t++)this._ctx.fillText(l[t],h[0],Math.ceil(h[1]))}computeSize(t,e){return this._options.transpose&&(t+=e,t-=e=t-e),[Math.floor(t/this._spacingX)-1,Math.floor((e-2*this._hexSize)/this._spacingY+1)]}computeFontSize(t,e){this._options.transpose&&(t+=e,t-=e=t-e);let i=2*t/((this._options.width+1)*Math.sqrt(3))-1,s=e/(2+1.5*(this._options.height-1)),r=Math.min(i,s),o=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let n=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=o;let h=n/100,l=2*(r=Math.floor(r)+1)/(this._options.spacing*(1+h/Math.sqrt(3)));return Math.ceil(l)-1}_normalizedEventToPosition(t,e){let i;this._options.transpose?(t+=e,t-=e=t-e,i=this._ctx.canvas.width):i=this._ctx.canvas.height;let s=i/this._options.height;return e=Math.floor(e/s),Object(h.mod)(e,2)?(t-=this._spacingX,t=1+2*Math.floor(t/(2*this._spacingX))):t=2*Math.floor(t/(2*this._spacingX)),[t,e]}_fill(t,e){let i=this._hexSize,s=this._options.border;const r=this._ctx;r.beginPath(),this._options.transpose?(r.moveTo(t-i+s,e),r.lineTo(t-i/2+s,e+this._spacingX-s),r.lineTo(t+i/2-s,e+this._spacingX-s),r.lineTo(t+i-s,e),r.lineTo(t+i/2-s,e-this._spacingX+s),r.lineTo(t-i/2+s,e-this._spacingX+s),r.lineTo(t-i+s,e)):(r.moveTo(t,e-i+s),r.lineTo(t+this._spacingX-s,e-i/2+s),r.lineTo(t+this._spacingX-s,e+i/2-s),r.lineTo(t,e+i-s),r.lineTo(t-this._spacingX+s,e+i/2-s),r.lineTo(t-this._spacingX+s,e-i/2+s),r.lineTo(t,e-i+s)),r.fill()}_updateSize(){const t=this._options,e=Math.ceil(this._ctx.measureText("W").width);let i,s;this._hexSize=Math.floor(t.spacing*(t.fontSize+e/Math.sqrt(3))/2),this._spacingX=this._hexSize*Math.sqrt(3)/2,this._spacingY=1.5*this._hexSize,t.transpose?(i="height",s="width"):(i="width",s="height"),this._ctx.canvas[i]=Math.ceil((t.width+1)*this._spacingX),this._ctx.canvas[s]=Math.ceil((t.height-1)*this._spacingY+2*this._hexSize)}}class a extends n{constructor(){super(),this._spacingX=0,this._spacingY=0,this._canvasCache={}}setOptions(t){super.setOptions(t),this._canvasCache={}}draw(t,e){a.cache?this._drawWithCache(t):this._drawNoCache(t,e)}_drawWithCache(t){let e,[i,s,r,o,n]=t,h=""+r+o+n;if(h in this._canvasCache)e=this._canvasCache[h];else{let t=this._options.border,i=(e=document.createElement("canvas")).getContext("2d");if(e.width=this._spacingX,e.height=this._spacingY,i.fillStyle=n,i.fillRect(t,t,e.width-t,e.height-t),r){i.fillStyle=o,i.font=this._ctx.font,i.textAlign="center",i.textBaseline="middle";let t=[].concat(r);for(let e=0;e<t.length;e++)i.fillText(t[e],this._spacingX/2,Math.ceil(this._spacingY/2))}this._canvasCache[h]=e}this._ctx.drawImage(e,i*this._spacingX,s*this._spacingY)}_drawNoCache(t,e){let[i,s,r,o,n]=t;if(e){let t=this._options.border;this._ctx.fillStyle=n,this._ctx.fillRect(i*this._spacingX+t,s*this._spacingY+t,this._spacingX-t,this._spacingY-t)}if(!r)return;this._ctx.fillStyle=o;let h=[].concat(r);for(let t=0;t<h.length;t++)this._ctx.fillText(h[t],(i+.5)*this._spacingX,Math.ceil((s+.5)*this._spacingY))}computeSize(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]}computeFontSize(t,e){let i=Math.floor(t/this._options.width),s=Math.floor(e/this._options.height),r=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let o=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=r;let n=o/100*s/i;return n>1&&(s=Math.floor(s/n)),Math.floor(s/this._options.spacing)}_normalizedEventToPosition(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]}_updateSize(){const t=this._options,e=Math.ceil(this._ctx.measureText("W").width);this._spacingX=Math.ceil(t.spacing*e),this._spacingY=Math.ceil(t.spacing*t.fontSize),t.forceSquareRatio&&(this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)),this._ctx.canvas.width=t.width*this._spacingX,this._ctx.canvas.height=t.height*this._spacingY}}a.cache=!1;class c extends n{constructor(){super(),this._colorCanvas=document.createElement("canvas")}draw(t,e){let[i,s,r,o,n]=t,h=this._options.tileWidth,l=this._options.tileHeight;if(e&&(this._options.tileColorize?this._ctx.clearRect(i*h,s*l,h,l):(this._ctx.fillStyle=n,this._ctx.fillRect(i*h,s*l,h,l))),!r)return;let a=[].concat(r),c=[].concat(o),u=[].concat(n);for(let t=0;t<a.length;t++){let e=this._options.tileMap[a[t]];if(!e)throw new Error(`Char "${a[t]}" not found in tileMap`);if(this._options.tileColorize){let r=this._colorCanvas,o=r.getContext("2d");o.globalCompositeOperation="source-over",o.clearRect(0,0,h,l);let n=c[t],a=u[t];o.drawImage(this._options.tileSet,e[0],e[1],h,l,0,0,h,l),"transparent"!=n&&(o.fillStyle=n,o.globalCompositeOperation="source-atop",o.fillRect(0,0,h,l)),"transparent"!=a&&(o.fillStyle=a,o.globalCompositeOperation="destination-over",o.fillRect(0,0,h,l)),this._ctx.drawImage(r,i*h,s*l,h,l)}else this._ctx.drawImage(this._options.tileSet,e[0],e[1],h,l,i*h,s*l,h,l)}}computeSize(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}computeFontSize(){throw new Error("Tile backend does not understand font size")}_normalizedEventToPosition(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}_updateSize(){const t=this._options;this._ctx.canvas.width=t.width*t.tileWidth,this._ctx.canvas.height=t.height*t.tileHeight,this._colorCanvas.width=t.tileWidth,this._colorCanvas.height=t.tileHeight}}var u=i(15);const d=/%([bc]){([^}]*)}/g,p=0,f=1,g=2,_=3;function m(t,e){let i={width:0,height:1},s=y(t,e),r=0;for(let t=0;t<s.length;t++){let e=s[t];switch(e.type){case p:r+=e.value.length;break;case f:i.height++,i.width=Math.max(i.width,r),r=0}}return i.width=Math.max(i.width,r),i}function y(t,e){let i=[],s=0;t.replace(d,function(e,r,o,n){let h=t.substring(s,n);return h.length&&i.push({type:p,value:h}),i.push({type:"c"==r?g:_,value:o.trim()}),s=n+e.length,""});let r=t.substring(s);return r.length&&i.push({type:p,value:r}),function(t,e){e||(e=1/0);let i=0,s=0,r=-1;for(;i<t.length;){let o=t[i];if(o.type==f&&(s=0,r=-1),o.type!=p){i++;continue}for(;0==s&&" "==o.value.charAt(0);)o.value=o.value.substring(1);let n=o.value.indexOf("\n");if(-1!=n){o.value=b(t,i,n,!0);let e=o.value.split("");for(;e.length&&" "==e[e.length-1];)e.pop();o.value=e.join("")}if(o.value.length){if(s+o.value.length>e){let n=-1;for(;;){let t=o.value.indexOf(" ",n+1);if(-1==t)break;if(s+t>e)break;n=t}if(-1!=n)o.value=b(t,i,n,!0);else if(-1!=r){let e=t[r],s=e.value.lastIndexOf(" ");e.value=b(t,r,s,!0),i=r}else o.value=b(t,i,e-s,!1)}else s+=o.value.length,-1!=o.value.indexOf(" ")&&(r=i);i++}else t.splice(i,1)}t.push({type:f});let o=null;for(let e=0;e<t.length;e++){let i=t[e];switch(i.type){case p:o=i;break;case f:if(o){let t=o.value.split("");for(;t.length&&" "==t[t.length-1];)t.pop();o.value=t.join("")}o=null}}return t.pop(),t}(i,e)}function b(t,e,i,s){let r={type:f},o={type:p,value:t[e].value.substring(i+(s?1:0))};return t.splice(e+1,0,r,o),t[e].value.substring(0,i)}let w=80,x=25;const v={4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]},M={VK_CANCEL:3,VK_HELP:6,VK_BACK_SPACE:8,VK_TAB:9,VK_CLEAR:12,VK_RETURN:13,VK_ENTER:14,VK_SHIFT:16,VK_CONTROL:17,VK_ALT:18,VK_PAUSE:19,VK_CAPS_LOCK:20,VK_ESCAPE:27,VK_SPACE:32,VK_PAGE_UP:33,VK_PAGE_DOWN:34,VK_END:35,VK_HOME:36,VK_LEFT:37,VK_UP:38,VK_RIGHT:39,VK_DOWN:40,VK_PRINTSCREEN:44,VK_INSERT:45,VK_DELETE:46,VK_0:48,VK_1:49,VK_2:50,VK_3:51,VK_4:52,VK_5:53,VK_6:54,VK_7:55,VK_8:56,VK_9:57,VK_COLON:58,VK_SEMICOLON:59,VK_LESS_THAN:60,VK_EQUALS:61,VK_GREATER_THAN:62,VK_QUESTION_MARK:63,VK_AT:64,VK_A:65,VK_B:66,VK_C:67,VK_D:68,VK_E:69,VK_F:70,VK_G:71,VK_H:72,VK_I:73,VK_J:74,VK_K:75,VK_L:76,VK_M:77,VK_N:78,VK_O:79,VK_P:80,VK_Q:81,VK_R:82,VK_S:83,VK_T:84,VK_U:85,VK_V:86,VK_W:87,VK_X:88,VK_Y:89,VK_Z:90,VK_CONTEXT_MENU:93,VK_NUMPAD0:96,VK_NUMPAD1:97,VK_NUMPAD2:98,VK_NUMPAD3:99,VK_NUMPAD4:100,VK_NUMPAD5:101,VK_NUMPAD6:102,VK_NUMPAD7:103,VK_NUMPAD8:104,VK_NUMPAD9:105,VK_MULTIPLY:106,VK_ADD:107,VK_SEPARATOR:108,VK_SUBTRACT:109,VK_DECIMAL:110,VK_DIVIDE:111,VK_F1:112,VK_F2:113,VK_F3:114,VK_F4:115,VK_F5:116,VK_F6:117,VK_F7:118,VK_F8:119,VK_F9:120,VK_F10:121,VK_F11:122,VK_F12:123,VK_F13:124,VK_F14:125,VK_F15:126,VK_F16:127,VK_F17:128,VK_F18:129,VK_F19:130,VK_F20:131,VK_F21:132,VK_F22:133,VK_F23:134,VK_F24:135,VK_NUM_LOCK:144,VK_SCROLL_LOCK:145,VK_CIRCUMFLEX:160,VK_EXCLAMATION:161,VK_DOUBLE_QUOTE:162,VK_HASH:163,VK_DOLLAR:164,VK_PERCENT:165,VK_AMPERSAND:166,VK_UNDERSCORE:167,VK_OPEN_PAREN:168,VK_CLOSE_PAREN:169,VK_ASTERISK:170,VK_PLUS:171,VK_PIPE:172,VK_HYPHEN_MINUS:173,VK_OPEN_CURLY_BRACKET:174,VK_CLOSE_CURLY_BRACKET:175,VK_TILDE:176,VK_COMMA:188,VK_PERIOD:190,VK_SLASH:191,VK_BACK_QUOTE:192,VK_OPEN_BRACKET:219,VK_BACK_SLASH:220,VK_CLOSE_BRACKET:221,VK_QUOTE:222,VK_META:224,VK_ALTGR:225,VK_WIN:91,VK_KANA:21,VK_HANGUL:21,VK_EISU:22,VK_JUNJA:23,VK_FINAL:24,VK_HANJA:25,VK_KANJI:25,VK_CONVERT:28,VK_NONCONVERT:29,VK_ACCEPT:30,VK_MODECHANGE:31,VK_SELECT:41,VK_PRINT:42,VK_EXECUTE:43,VK_SLEEP:95},S={hex:l,rect:a,tile:c,term:u.a},C={width:w,height:x,transpose:!1,layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:!1,fontFamily:"monospace",fontStyle:"",fg:"#ccc",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:!1};class k{constructor(t={}){this._data={},this._dirty=!1,this._options={},t=Object.assign({},C,t),this.setOptions(t),this.DEBUG=this.DEBUG.bind(this),this._tick=this._tick.bind(this),this._backend.schedule(this._tick)}DEBUG(t,e,i){let s=[this._options.bg,this._options.fg];this.draw(t,e,null,null,s[i%s.length])}clear(){this._data={},this._dirty=!0}setOptions(t){if(Object.assign(this._options,t),t.width||t.height||t.fontSize||t.fontFamily||t.spacing||t.layout){if(t.layout){let e=S[t.layout];this._backend=new e}this._backend.setOptions(this._options),this._dirty=!0}return this}getOptions(){return this._options}getContainer(){return this._backend.getContainer()}computeSize(t,e){return this._backend.computeSize(t,e)}computeFontSize(t,e){return this._backend.computeFontSize(t,e)}computeTileSize(t,e){return[Math.floor(t/this._options.width),Math.floor(e/this._options.height)]}eventToPosition(t){let e,i;return"touches"in t?(e=t.touches[0].clientX,i=t.touches[0].clientY):(e=t.clientX,i=t.clientY),this._backend.eventToPosition(e,i)}draw(t,e,i,s,r){s||(s=this._options.fg),r||(r=this._options.bg);let o=`${t},${e}`;this._data[o]=[t,e,i,s,r],!0!==this._dirty&&(this._dirty||(this._dirty={}),this._dirty[o]=!0)}drawText(t,e,i,s){let r=null,o=null,n=t,h=e,l=1;s||(s=this._options.width-t);let a=y(i,s);for(;a.length;){let e=a.shift();switch(e.type){case p:let i=!1,s=!1,a=!1,c=!1;for(let t=0;t<e.value.length;t++){let l=e.value.charCodeAt(t),u=e.value.charAt(t);a=l>65280&&l<65377||l>65500&&l<65512||l>65518,i=32==u.charCodeAt(0)||12288==u.charCodeAt(0),!c||a||i||n++,a&&!s&&n++,this.draw(n++,h,u,r,o),s=i,c=a}break;case g:r=e.value||null;break;case _:o=e.value||null;break;case f:n=t,h++,l++}}return l}_tick(){if(this._backend.schedule(this._tick),this._dirty){if(!0===this._dirty){this._backend.clear();for(let t in this._data)this._draw(t,!1)}else for(let t in this._dirty)this._draw(t,!0);this._dirty=!1}}_draw(t,e){let i=this._data[t];i[4]!=this._options.bg&&(e=!0),this._backend.draw(i,e)}}k.Rect=a,k.Hex=l,k.Tile=c,k.Term=u.a;class P{constructor(t){this._options={words:!1,order:3,prior:.001},Object.assign(this._options,t),this._boundary=String.fromCharCode(0),this._suffix=this._boundary,this._prefix=[];for(let t=0;t<this._options.order;t++)this._prefix.push(this._boundary);this._priorValues={},this._priorValues[this._boundary]=this._options.prior,this._data={}}clear(){this._data={},this._priorValues={}}generate(){let t=[this._sample(this._prefix)];for(;t[t.length-1]!=this._boundary;)t.push(this._sample(t));return this._join(t.slice(0,-1))}observe(t){let e=this._split(t);for(let t=0;t<e.length;t++)this._priorValues[e[t]]=this._options.prior;e=this._prefix.concat(e).concat(this._suffix);for(let t=this._options.order;t<e.length;t++){let i=e.slice(t-this._options.order,t),s=e[t];for(let t=0;t<i.length;t++){let e=i.slice(t);this._observeEvent(e,s)}}}getStats(){let t=[],e=Object.keys(this._priorValues).length;e--,t.push("distinct samples: "+e);let i=Object.keys(this._data).length,s=0;for(let t in this._data)s+=Object.keys(this._data[t]).length;return t.push("dictionary size (contexts): "+i),t.push("dictionary size (events): "+s),t.join(", ")}_split(t){return t.split(this._options.words?/\s+/:"")}_join(t){return t.join(this._options.words?" ":"")}_observeEvent(t,e){let i=this._join(t);i in this._data||(this._data[i]={});let s=this._data[i];e in s||(s[e]=0),s[e]++}_sample(t){t=this._backoff(t);let e=this._join(t),i=this._data[e],s={};if(this._options.prior){for(let t in this._priorValues)s[t]=this._priorValues[t];for(let t in i)s[t]+=i[t]}else s=i;return r.a.getWeightedValue(s)}_backoff(t){for(t.length>this._options.order?t=t.slice(-this._options.order):t.length<this._options.order&&(t=this._prefix.slice(0,this._options.order-t.length).concat(t));!(this._join(t)in this._data)&&t.length>0;)t=t.slice(1);return t}}class T{constructor(){this._time=0,this._events=[],this._eventTimes=[]}getTime(){return this._time}clear(){return this._events=[],this._eventTimes=[],this}add(t,e){let i=this._events.length;for(let t=0;t<this._eventTimes.length;t++)if(this._eventTimes[t]>e){i=t;break}this._events.splice(i,0,t),this._eventTimes.splice(i,0,e)}get(){if(!this._events.length)return null;let t=this._eventTimes.splice(0,1)[0];if(t>0){this._time+=t;for(let e=0;e<this._eventTimes.length;e++)this._eventTimes[e]-=t}return this._events.splice(0,1)[0]}getEventTime(t){let e=this._events.indexOf(t);if(-1!=e)return this._eventTimes[e]}remove(t){let e=this._events.indexOf(t);return-1!=e&&(this._remove(e),!0)}_remove(t){this._events.splice(t,1),this._eventTimes.splice(t,1)}}class R{constructor(){this._queue=new T,this._repeat=[],this._current=null}getTime(){return this._queue.getTime()}add(t,e){return e&&this._repeat.push(t),this}getTimeOf(t){return this._queue.getEventTime(t)}clear(){return this._queue.clear(),this._repeat=[],this._current=null,this}remove(t){let e=this._queue.remove(t),i=this._repeat.indexOf(t);return-1!=i&&this._repeat.splice(i,1),this._current==t&&(this._current=null),e}next(){return this._current=this._queue.get(),this._current}}var F={Simple:class extends R{add(t,e){return this._queue.add(t,0),super.add(t,e)}next(){return this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,0),super.next()}},Speed:class extends R{add(t,e,i){return this._queue.add(t,void 0!==i?i:1/t.getSpeed()),super.add(t,e)}next(){return this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,1/this._current.getSpeed()),super.next()}},Action:class extends R{constructor(){super(),this._defaultDuration=1,this._duration=this._defaultDuration}add(t,e,i){return this._queue.add(t,i||this._defaultDuration),super.add(t,e)}clear(){return this._duration=this._defaultDuration,super.clear()}remove(t){return t==this._current&&(this._duration=this._defaultDuration),super.remove(t)}next(){return this._current&&-1!=this._repeat.indexOf(this._current)&&(this._queue.add(this._current,this._duration||this._defaultDuration),this._duration=this._defaultDuration),super.next()}setDuration(t){return this._current&&(this._duration=t),this}}};class z{constructor(t,e={}){this._lightPasses=t,this._options=Object.assign({topology:8},e)}_getCircle(t,e,i){let s,r,o,n=[];switch(this._options.topology){case 4:r=1,o=[0,1],s=[v[8][7],v[8][1],v[8][3],v[8][5]];break;case 6:s=v[6],r=1,o=[-1,1];break;case 8:s=v[4],r=2,o=[-1,1];break;default:throw new Error("Incorrect topology for FOV computation")}let h=t+o[0]*i,l=e+o[1]*i;for(let t=0;t<s.length;t++)for(let e=0;e<i*r;e++)n.push([h,l]),h+=s[t][0],l+=s[t][1];return n}}const E=[[-1,0,0,1],[0,-1,1,0],[0,-1,-1,0],[-1,0,0,-1],[1,0,0,-1],[0,1,-1,0],[0,1,1,0],[1,0,0,1]];var A={DiscreteShadowcasting:class extends z{compute(t,e,i,s){if(s(t,e,0,1),!this._lightPasses(t,e))return;let r,o,n,h,l,a=[];for(let c=1;c<=i;c++){let i=this._getCircle(t,e,c),u=360/i.length;for(let t=0;t<i.length;t++)if(n=i[t][0],h=i[t][1],o=(r=u*(t-.5))+u,l=!this._lightPasses(n,h),this._visibleCoords(Math.floor(r),Math.ceil(o),l,a)&&s(n,h,c,1),2==a.length&&0==a[0]&&360==a[1])return}}_visibleCoords(t,e,i,s){if(t<0){let r=this._visibleCoords(0,e,i,s),o=this._visibleCoords(360+t,360,i,s);return r||o}let r=0;for(;r<s.length&&s[r]<t;)r++;if(r==s.length)return i&&s.push(t,e),!0;let o=0;if(r%2){for(;r<s.length&&s[r]<e;)r++,o++;return 0!=o&&(i&&(o%2?s.splice(r-o,o,e):s.splice(r-o,o)),!0)}for(;r<s.length&&s[r]<e;)r++,o++;return(t!=s[r-o]||1!=o)&&(i&&(o%2?s.splice(r-o,o,t):s.splice(r-o,o,t,e)),!0)}},PreciseShadowcasting:class extends z{compute(t,e,i,s){if(s(t,e,0,1),!this._lightPasses(t,e))return;let r,o,n,h,l,a,c=[];for(let u=1;u<=i;u++){let i=this._getCircle(t,e,u),d=i.length;for(let t=0;t<d;t++)if(r=i[t][0],o=i[t][1],h=[t?2*t-1:2*d-1,2*d],l=[2*t+1,2*d],n=!this._lightPasses(r,o),(a=this._checkVisibility(h,l,n,c))&&s(r,o,u,a),2==c.length&&0==c[0][0]&&c[1][0]==c[1][1])return}}_checkVisibility(t,e,i,s){if(t[0]>e[0])return(this._checkVisibility(t,[t[1],t[1]],i,s)+this._checkVisibility([0,1],e,i,s))/2;let r=0,o=!1;for(;r<s.length;){let e=s[r],i=e[0]*t[1]-t[0]*e[1];if(i>=0){0!=i||r%2||(o=!0);break}r++}let n=s.length,h=!1;for(;n--;){let t=s[n],i=e[0]*t[1]-t[0]*e[1];if(i>=0){0==i&&n%2&&(h=!0);break}}let l,a=!0;if(r==n&&(o||h)?a=!1:o&&h&&r+1==n&&n%2?a=!1:r>n&&r%2&&(a=!1),!a)return 0;let c=n-r+1;if(c%2)if(r%2){let t=s[r];l=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]),i&&s.splice(r,c,e)}else{let e=s[n];l=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]),i&&s.splice(r,c,t)}else{if(!(r%2))return i&&s.splice(r,c,t,e),1;{let t=s[r],e=s[n];l=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]),i&&s.splice(r,c)}}return l/((e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]))}},RecursiveShadowcasting:class extends z{compute(t,e,i,s){s(t,e,0,1);for(let r=0;r<E.length;r++)this._renderOctant(t,e,E[r],i,s)}compute180(t,e,i,s,r){r(t,e,0,1);let o=(s-1+8)%8,n=(s-2+8)%8,h=(s+1+8)%8;this._renderOctant(t,e,E[n],i,r),this._renderOctant(t,e,E[o],i,r),this._renderOctant(t,e,E[s],i,r),this._renderOctant(t,e,E[h],i,r)}compute90(t,e,i,s,r){r(t,e,0,1);let o=(s-1+8)%8;this._renderOctant(t,e,E[s],i,r),this._renderOctant(t,e,E[o],i,r)}_renderOctant(t,e,i,s,r){this._castVisibility(t,e,1,1,0,s+1,i[0],i[1],i[2],i[3],r)}_castVisibility(t,e,i,s,r,o,n,h,l,a,c){if(!(s<r))for(let u=i;u<=o;u++){let i=-u-1,d=-u,p=!1,f=0;for(;i<=0;){let g=t+(i+=1)*n+d*h,_=e+i*l+d*a,m=(i-.5)/(d+.5),y=(i+.5)/(d-.5);if(!(y>s)){if(m<r)break;if(i*i+d*d<o*o&&c(g,_,u,1),p){if(!this._lightPasses(g,_)){f=y;continue}p=!1,s=f}else!this._lightPasses(g,_)&&u<o&&(p=!0,this._castVisibility(t,e,u+1,s,m,o,n,h,l,a,c),f=y)}}if(p)break}}}};class I{constructor(t=w,e=x){this._width=t,this._height=e}_fillMap(t){let e=[];for(let i=0;i<this._width;i++){e.push([]);for(let s=0;s<this._height;s++)e[i].push(t)}return e}}class V extends I{constructor(t,e){super(t,e),this._rooms=[],this._corridors=[]}getRooms(){return this._rooms}getCorridors(){return this._corridors}}class K{}class O extends K{constructor(t,e,i,s,r,o){super(),this._x1=t,this._y1=e,this._x2=i,this._y2=s,this._doors={},void 0!==r&&void 0!==o&&this.addDoor(r,o)}static createRandomAt(t,e,i,s,o){let n=o.roomWidth[0],h=o.roomWidth[1],l=r.a.getUniformInt(n,h);n=o.roomHeight[0],h=o.roomHeight[1];let a=r.a.getUniformInt(n,h);if(1==i){let i=e-Math.floor(r.a.getUniform()*a);return new this(t+1,i,t+l,i+a-1,t,e)}if(-1==i){let i=e-Math.floor(r.a.getUniform()*a);return new this(t-l,i,t-1,i+a-1,t,e)}if(1==s){let i=t-Math.floor(r.a.getUniform()*l);return new this(i,e+1,i+l-1,e+a,t,e)}if(-1==s){let i=t-Math.floor(r.a.getUniform()*l);return new this(i,e-a,i+l-1,e-1,t,e)}throw new Error("dx or dy must be 1 or -1")}static createRandomCenter(t,e,i){let s=i.roomWidth[0],o=i.roomWidth[1],n=r.a.getUniformInt(s,o);s=i.roomHeight[0],o=i.roomHeight[1];let h=r.a.getUniformInt(s,o),l=t-Math.floor(r.a.getUniform()*n),a=e-Math.floor(r.a.getUniform()*h);return new this(l,a,l+n-1,a+h-1)}static createRandom(t,e,i){let s=i.roomWidth[0],o=i.roomWidth[1],n=r.a.getUniformInt(s,o);s=i.roomHeight[0],o=i.roomHeight[1];let h=r.a.getUniformInt(s,o),l=t-n-1,a=e-h-1,c=1+Math.floor(r.a.getUniform()*l),u=1+Math.floor(r.a.getUniform()*a);return new this(c,u,c+n-1,u+h-1)}addDoor(t,e){return this._doors[t+","+e]=1,this}getDoors(t){for(let e in this._doors){let i=e.split(",");t(parseInt(i[0]),parseInt(i[1]))}return this}clearDoors(){return this._doors={},this}addDoors(t){let e=this._x1-1,i=this._x2+1,s=this._y1-1,r=this._y2+1;for(let o=e;o<=i;o++)for(let n=s;n<=r;n++)o!=e&&o!=i&&n!=s&&n!=r||t(o,n)||this.addDoor(o,n);return this}debug(){console.log("room",this._x1,this._y1,this._x2,this._y2)}isValid(t,e){let i=this._x1-1,s=this._x2+1,r=this._y1-1,o=this._y2+1;for(let n=i;n<=s;n++)for(let h=r;h<=o;h++)if(n==i||n==s||h==r||h==o){if(!t(n,h))return!1}else if(!e(n,h))return!1;return!0}create(t){let e=this._x1-1,i=this._x2+1,s=this._y1-1,r=this._y2+1,o=0;for(let n=e;n<=i;n++)for(let h=s;h<=r;h++)t(n,h,o=n+","+h in this._doors?2:n==e||n==i||h==s||h==r?1:0)}getCenter(){return[Math.round((this._x1+this._x2)/2),Math.round((this._y1+this._y2)/2)]}getLeft(){return this._x1}getRight(){return this._x2}getTop(){return this._y1}getBottom(){return this._y2}}class D extends K{constructor(t,e,i,s){super(),this._startX=t,this._startY=e,this._endX=i,this._endY=s,this._endsWithAWall=!0}static createRandomAt(t,e,i,s,o){let n=o.corridorLength[0],h=o.corridorLength[1],l=r.a.getUniformInt(n,h);return new this(t,e,t+i*l,e+s*l)}debug(){console.log("corridor",this._startX,this._startY,this._endX,this._endY)}isValid(t,e){let i=this._startX,s=this._startY,r=this._endX-i,o=this._endY-s,n=1+Math.max(Math.abs(r),Math.abs(o));r&&(r/=Math.abs(r)),o&&(o/=Math.abs(o));let h=o,l=-r,a=!0;for(let c=0;c<n;c++){let u=i+c*r,d=s+c*o;if(e(u,d)||(a=!1),t(u+h,d+l)||(a=!1),t(u-h,d-l)||(a=!1),!a){n=c,this._endX=u-r,this._endY=d-o;break}}if(0==n)return!1;if(1==n&&t(this._endX+r,this._endY+o))return!1;let c=!t(this._endX+r+h,this._endY+o+l),u=!t(this._endX+r-h,this._endY+o-l);return this._endsWithAWall=t(this._endX+r,this._endY+o),!c&&!u||!this._endsWithAWall}create(t){let e=this._startX,i=this._startY,s=this._endX-e,r=this._endY-i,o=1+Math.max(Math.abs(s),Math.abs(r));s&&(s/=Math.abs(s)),r&&(r/=Math.abs(r));for(let n=0;n<o;n++){t(e+n*s,i+n*r,0)}return!0}createPriorityWalls(t){if(!this._endsWithAWall)return;let e=this._startX,i=this._startY,s=this._endX-e,r=this._endY-i;s&&(s/=Math.abs(s)),r&&(r/=Math.abs(r));let o=r,n=-s;t(this._endX+s,this._endY+r),t(this._endX+o,this._endY+n),t(this._endX-o,this._endY-n)}}const L={room:O,corridor:D};function N(t,e,i){i[e[t+1]]=i[t],e[i[t]]=e[t+1],i[t]=t+1,e[t+1]=t}function U(t,e,i){i[e[t]]=i[t],e[i[t]]=e[t],i[t]=t,e[t]=t}var W={Arena:class extends I{create(t){let e=this._width-1,i=this._height-1;for(let s=0;s<=e;s++)for(let r=0;r<=i;r++)t(s,r,s&&r&&s<e&&r<i?0:1);return this}},Uniform:class extends V{constructor(t,e,i){super(t,e),this._options={roomWidth:[3,9],roomHeight:[3,5],roomDugPercentage:.1,timeLimit:1e3},Object.assign(this._options,i),this._map=[],this._dug=0,this._roomAttempts=20,this._corridorAttempts=20,this._connected=[],this._unconnected=[],this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this)}create(t){let e=Date.now();for(;;){if(Date.now()-e>this._options.timeLimit)return null;if(this._map=this._fillMap(1),this._dug=0,this._rooms=[],this._unconnected=[],this._generateRooms(),!(this._rooms.length<2)&&this._generateCorridors())break}if(t)for(let e=0;e<this._width;e++)for(let i=0;i<this._height;i++)t(e,i,this._map[e][i]);return this}_generateRooms(){let t,e=this._width-2,i=this._height-2;do{if(t=this._generateRoom(),this._dug/(e*i)>this._options.roomDugPercentage)break}while(t)}_generateRoom(){let t=0;for(;t<this._roomAttempts;){t++;let e=O.createRandom(this._width,this._height,this._options);if(e.isValid(this._isWallCallback,this._canBeDugCallback))return e.create(this._digCallback),this._rooms.push(e),e}return null}_generateCorridors(){let t=0;for(;t<this._corridorAttempts;){t++,this._corridors=[],this._map=this._fillMap(1);for(let t=0;t<this._rooms.length;t++){let e=this._rooms[t];e.clearDoors(),e.create(this._digCallback)}for(this._unconnected=r.a.shuffle(this._rooms.slice()),this._connected=[],this._unconnected.length&&this._connected.push(this._unconnected.pop());;){let t=r.a.getItem(this._connected);if(!t)break;let e=this._closestRoom(this._unconnected,t);if(!e)break;let i=this._closestRoom(this._connected,e);if(!i)break;if(!this._connectRooms(e,i))break;if(!this._unconnected.length)return!0}}return!1}_closestRoom(t,e){let i=1/0,s=e.getCenter(),r=null;for(let e=0;e<t.length;e++){let o=t[e],n=o.getCenter(),h=n[0]-s[0],l=n[1]-s[1],a=h*h+l*l;a<i&&(i=a,r=o)}return r}_connectRooms(t,e){let i,s,r,o,n,h,l,a=t.getCenter(),c=e.getCenter(),u=c[0]-a[0],d=c[1]-a[1];if(Math.abs(u)<Math.abs(d)?(o=(2+(r=d>0?2:0))%4,n=e.getLeft(),h=e.getRight(),l=0):(o=(2+(r=u>0?1:3))%4,n=e.getTop(),h=e.getBottom(),l=1),!(i=this._placeInWall(t,r)))return!1;if(i[l]>=n&&i[l]<=h){s=i.slice();let t=0;switch(o){case 0:t=e.getTop()-1;break;case 1:t=e.getRight()+1;break;case 2:t=e.getBottom()+1;break;case 3:t=e.getLeft()-1}s[(l+1)%2]=t,this._digLine([i,s])}else if(i[l]<n-1||i[l]>h+1){let t=i[l]-c[l],r=0;switch(o){case 0:case 1:r=t<0?3:1;break;case 2:case 3:r=t<0?1:3}if(o=(o+r)%4,!(s=this._placeInWall(e,o)))return!1;let n=[0,0];n[l]=i[l];let h=(l+1)%2;n[h]=s[h],this._digLine([i,n,s])}else{let t=(l+1)%2;if(!(s=this._placeInWall(e,o)))return!1;let r=Math.round((s[t]+i[t])/2),n=[0,0],h=[0,0];n[l]=i[l],n[t]=r,h[l]=s[l],h[t]=r,this._digLine([i,n,h,s])}return t.addDoor(i[0],i[1]),e.addDoor(s[0],s[1]),-1!=(l=this._unconnected.indexOf(t))&&(this._unconnected.splice(l,1),this._connected.push(t)),-1!=(l=this._unconnected.indexOf(e))&&(this._unconnected.splice(l,1),this._connected.push(e)),!0}_placeInWall(t,e){let i=[0,0],s=[0,0],o=0;switch(e){case 0:s=[1,0],i=[t.getLeft(),t.getTop()-1],o=t.getRight()-t.getLeft()+1;break;case 1:s=[0,1],i=[t.getRight()+1,t.getTop()],o=t.getBottom()-t.getTop()+1;break;case 2:s=[1,0],i=[t.getLeft(),t.getBottom()+1],o=t.getRight()-t.getLeft()+1;break;case 3:s=[0,1],i=[t.getLeft()-1,t.getTop()],o=t.getBottom()-t.getTop()+1}let n=[],h=-2;for(let t=0;t<o;t++){let e=i[0]+t*s[0],r=i[1]+t*s[1];n.push(null),1==this._map[e][r]?h!=t-1&&(n[t]=[e,r]):(h=t,t&&(n[t-1]=null))}for(let t=n.length-1;t>=0;t--)n[t]||n.splice(t,1);return n.length?r.a.getItem(n):null}_digLine(t){for(let e=1;e<t.length;e++){let i=t[e-1],s=t[e],r=new D(i[0],i[1],s[0],s[1]);r.create(this._digCallback),this._corridors.push(r)}}_digCallback(t,e,i){this._map[t][e]=i,0==i&&this._dug++}_isWallCallback(t,e){return!(t<0||e<0||t>=this._width||e>=this._height)&&1==this._map[t][e]}_canBeDugCallback(t,e){return!(t<1||e<1||t+1>=this._width||e+1>=this._height)&&1==this._map[t][e]}},Cellular:class extends I{constructor(t,e,i={}){super(t,e),this._options={born:[5,6,7,8],survive:[4,5,6,7,8],topology:8},this.setOptions(i),this._dirs=v[this._options.topology],this._map=this._fillMap(0)}randomize(t){for(let e=0;e<this._width;e++)for(let i=0;i<this._height;i++)this._map[e][i]=r.a.getUniform()<t?1:0;return this}setOptions(t){Object.assign(this._options,t)}set(t,e,i){this._map[t][e]=i}create(t){let e=this._fillMap(0),i=this._options.born,s=this._options.survive;for(let t=0;t<this._height;t++){let r=1,o=0;6==this._options.topology&&(r=2,o=t%2);for(let n=o;n<this._width;n+=r){let r=this._map[n][t],o=this._getNeighbors(n,t);r&&-1!=s.indexOf(o)?e[n][t]=1:r||-1==i.indexOf(o)||(e[n][t]=1)}}this._map=e,t&&this._serviceCallback(t)}_serviceCallback(t){for(let e=0;e<this._height;e++){let i=1,s=0;6==this._options.topology&&(i=2,s=e%2);for(let r=s;r<this._width;r+=i)t(r,e,this._map[r][e])}}_getNeighbors(t,e){let i=0;for(let s=0;s<this._dirs.length;s++){let r=this._dirs[s],o=t+r[0],n=e+r[1];o<0||o>=this._width||n<0||n>=this._height||(i+=1==this._map[o][n]?1:0)}return i}connect(t,e,i){e||(e=0);let s=[],o={},n=1,h=[0,0];6==this._options.topology&&(n=2,h=[0,1]);for(let t=0;t<this._height;t++)for(let i=h[t%2];i<this._width;i+=n)if(this._freeSpace(i,t,e)){let e=[i,t];o[this._pointKey(e)]=e,s.push([i,t])}let l=s[r.a.getUniformInt(0,s.length-1)],a=this._pointKey(l),c={};for(c[a]=l,delete o[a],this._findConnected(c,o,[l],!1,e);Object.keys(o).length>0;){let t=this._getFromTo(c,o),s=t[0],r=t[1],n={};n[this._pointKey(s)]=s,this._findConnected(n,o,[s],!0,e),(6==this._options.topology?this._tunnelToConnected6:this._tunnelToConnected).call(this,r,s,c,o,e,i);for(let t in n){let i=n[t];this._map[i[0]][i[1]]=e,c[t]=i,delete o[t]}}t&&this._serviceCallback(t)}_getFromTo(t,e){let i,s=[0,0],o=[0,0],n=Object.keys(t),h=Object.keys(e);for(let l=0;l<5;l++){if(n.length<h.length){let i=n;o=t[i[r.a.getUniformInt(0,i.length-1)]],s=this._getClosest(o,e)}else{let i=h;s=e[i[r.a.getUniformInt(0,i.length-1)]],o=this._getClosest(s,t)}if((i=(s[0]-o[0])*(s[0]-o[0])+(s[1]-o[1])*(s[1]-o[1]))<64)break}return[s,o]}_getClosest(t,e){let i=null,s=null;for(let r in e){let o=e[r],n=(o[0]-t[0])*(o[0]-t[0])+(o[1]-t[1])*(o[1]-t[1]);(null==s||n<s)&&(s=n,i=o)}return i}_findConnected(t,e,i,s,r){for(;i.length>0;){let o,n=i.splice(0,1)[0];o=6==this._options.topology?[[n[0]+2,n[1]],[n[0]+1,n[1]-1],[n[0]-1,n[1]-1],[n[0]-2,n[1]],[n[0]-1,n[1]+1],[n[0]+1,n[1]+1]]:[[n[0]+1,n[1]],[n[0]-1,n[1]],[n[0],n[1]+1],[n[0],n[1]-1]];for(let n=0;n<o.length;n++){let h=this._pointKey(o[n]);null==t[h]&&this._freeSpace(o[n][0],o[n][1],r)&&(t[h]=o[n],s||delete e[h],i.push(o[n]))}}}_tunnelToConnected(t,e,i,s,r,o){let n,h;e[0]<t[0]?(n=e,h=t):(n=t,h=e);for(let t=n[0];t<=h[0];t++){this._map[t][n[1]]=r;let e=[t,n[1]],o=this._pointKey(e);i[o]=e,delete s[o]}o&&n[0]<h[0]&&o(n,[h[0],n[1]]);let l=h[0];e[1]<t[1]?(n=e,h=t):(n=t,h=e);for(let t=n[1];t<h[1];t++){this._map[l][t]=r;let e=[l,t],o=this._pointKey(e);i[o]=e,delete s[o]}o&&n[1]<h[1]&&o([h[0],n[1]],[h[0],h[1]])}_tunnelToConnected6(t,e,i,s,r,o){let n,h;e[0]<t[0]?(n=e,h=t):(n=t,h=e);let l=n[0],a=n[1];for(;l!=h[0]||a!=h[1];){let t=2;a<h[1]?(a++,t=1):a>h[1]&&(a--,t=1),l<h[0]?l+=t:l>h[0]?l-=t:h[1]%2?l-=t:l+=t,this._map[l][a]=r;let e=[l,a],o=this._pointKey(e);i[o]=e,delete s[o]}o&&o(e,t)}_freeSpace(t,e,i){return t>=0&&t<this._width&&e>=0&&e<this._height&&this._map[t][e]==i}_pointKey(t){return t[0]+"."+t[1]}},Digger:class extends V{constructor(t,e,i={}){super(t,e),this._options=Object.assign({roomWidth:[3,9],roomHeight:[3,5],corridorLength:[3,10],dugPercentage:.2,timeLimit:1e3},i),this._features={room:4,corridor:4},this._map=[],this._featureAttempts=20,this._walls={},this._dug=0,this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this),this._priorityWallCallback=this._priorityWallCallback.bind(this)}create(t){this._rooms=[],this._corridors=[],this._map=this._fillMap(1),this._walls={},this._dug=0;let e=(this._width-2)*(this._height-2);this._firstRoom();let i,s=Date.now();do{if(i=0,Date.now()-s>this._options.timeLimit)break;let t=this._findWall();if(!t)break;let e=t.split(","),r=parseInt(e[0]),o=parseInt(e[1]),n=this._getDiggingDirection(r,o);if(!n)continue;let h=0;do{if(h++,this._tryFeature(r,o,n[0],n[1])){this._removeSurroundingWalls(r,o),this._removeSurroundingWalls(r-n[0],o-n[1]);break}}while(h<this._featureAttempts);for(let t in this._walls)this._walls[t]>1&&i++}while(this._dug/e<this._options.dugPercentage||i);if(this._addDoors(),t)for(let e=0;e<this._width;e++)for(let i=0;i<this._height;i++)t(e,i,this._map[e][i]);return this._walls={},this._map=[],this}_digCallback(t,e,i){0==i||2==i?(this._map[t][e]=0,this._dug++):this._walls[t+","+e]=1}_isWallCallback(t,e){return!(t<0||e<0||t>=this._width||e>=this._height)&&1==this._map[t][e]}_canBeDugCallback(t,e){return!(t<1||e<1||t+1>=this._width||e+1>=this._height)&&1==this._map[t][e]}_priorityWallCallback(t,e){this._walls[t+","+e]=2}_firstRoom(){let t=Math.floor(this._width/2),e=Math.floor(this._height/2),i=O.createRandomCenter(t,e,this._options);this._rooms.push(i),i.create(this._digCallback)}_findWall(){let t=[],e=[];for(let i in this._walls)2==this._walls[i]?e.push(i):t.push(i);let i=e.length?e:t;if(!i.length)return null;let s=r.a.getItem(i.sort());return delete this._walls[s],s}_tryFeature(t,e,i,s){let o=r.a.getWeightedValue(this._features),n=L[o].createRandomAt(t,e,i,s,this._options);return!!n.isValid(this._isWallCallback,this._canBeDugCallback)&&(n.create(this._digCallback),n instanceof O&&this._rooms.push(n),n instanceof D&&(n.createPriorityWalls(this._priorityWallCallback),this._corridors.push(n)),!0)}_removeSurroundingWalls(t,e){let i=v[4];for(let s=0;s<i.length;s++){let r=i[s],o=t+r[0],n=e+r[1];delete this._walls[o+","+n],o=t+2*r[0],n=e+2*r[1],delete this._walls[o+","+n]}}_getDiggingDirection(t,e){if(t<=0||e<=0||t>=this._width-1||e>=this._height-1)return null;let i=null,s=v[4];for(let r=0;r<s.length;r++){let o=s[r],n=t+o[0],h=e+o[1];if(!this._map[n][h]){if(i)return null;i=o}}return i?[-i[0],-i[1]]:null}_addDoors(){let t=this._map;function e(e,i){return 1==t[e][i]}for(let t=0;t<this._rooms.length;t++){let i=this._rooms[t];i.clearDoors(),i.addDoors(e)}}},EllerMaze:class extends I{create(t){let e,i=this._fillMap(1),s=Math.ceil((this._width-2)/2),o=[],n=[];for(let t=0;t<s;t++)o.push(t),n.push(t);for(o.push(s-1),e=1;e+3<this._height;e+=2)for(let t=0;t<s;t++){let s=2*t+1,h=e;i[s][h]=0,t!=o[t+1]&&r.a.getUniform()>.375&&(N(t,o,n),i[s+1][h]=0),t!=o[t]&&r.a.getUniform()>.375?U(t,o,n):i[s][h+1]=0}for(let t=0;t<s;t++){let s=2*t+1,h=e;i[s][h]=0,t!=o[t+1]&&(t==o[t]||r.a.getUniform()>.375)&&(N(t,o,n),i[s+1][h]=0),U(t,o,n)}for(let e=0;e<this._width;e++)for(let s=0;s<this._height;s++)t(e,s,i[e][s]);return this}},DividedMaze:class extends I{constructor(){super(...arguments),this._stack=[],this._map=[]}create(t){let e=this._width,i=this._height;this._map=[];for(let t=0;t<e;t++){this._map.push([]);for(let s=0;s<i;s++){let r=0==t||0==s||t+1==e||s+1==i;this._map[t].push(r?1:0)}}this._stack=[[1,1,e-2,i-2]],this._process();for(let s=0;s<e;s++)for(let e=0;e<i;e++)t(s,e,this._map[s][e]);return this._map=[],this}_process(){for(;this._stack.length;){let t=this._stack.shift();this._partitionRoom(t)}}_partitionRoom(t){let e=[],i=[];for(let i=t[0]+1;i<t[2];i++){let s=this._map[i][t[1]-1],r=this._map[i][t[3]+1];!s||!r||i%2||e.push(i)}for(let e=t[1]+1;e<t[3];e++){let s=this._map[t[0]-1][e],r=this._map[t[2]+1][e];!s||!r||e%2||i.push(e)}if(!e.length||!i.length)return;let s=r.a.getItem(e),o=r.a.getItem(i);this._map[s][o]=1;let n=[],h=[];n.push(h);for(let e=t[0];e<s;e++)this._map[e][o]=1,h.push([e,o]);h=[],n.push(h);for(let e=s+1;e<=t[2];e++)this._map[e][o]=1,h.push([e,o]);h=[],n.push(h);for(let e=t[1];e<o;e++)this._map[s][e]=1,h.push([s,e]);h=[],n.push(h);for(let e=o+1;e<=t[3];e++)this._map[s][e]=1,h.push([s,e]);let l=r.a.getItem(n);for(let t=0;t<n.length;t++){let e=n[t];if(e==l)continue;let i=r.a.getItem(e);this._map[i[0]][i[1]]=0}this._stack.push([t[0],t[1],s-1,o-1]),this._stack.push([s+1,t[1],t[2],o-1]),this._stack.push([t[0],o+1,s-1,t[3]]),this._stack.push([s+1,o+1,t[2],t[3]])}},IceyMaze:class extends I{constructor(t,e,i=0){super(t,e),this._regularity=i,this._map=[]}create(t){let e=this._width,i=this._height,s=this._fillMap(1);e-=e%2?1:2,i-=i%2?1:2;let o=0,n=0,h=0,l=0,a=0,c=!1,u=[[0,0],[0,0],[0,0],[0,0]];do{if(o=1+2*Math.floor(r.a.getUniform()*(e-1)/2),n=1+2*Math.floor(r.a.getUniform()*(i-1)/2),a||(s[o][n]=0),!s[o][n]){this._randomize(u);do{0==Math.floor(r.a.getUniform()*(this._regularity+1))&&this._randomize(u),c=!0;for(let t=0;t<4;t++)if(h=o+2*u[t][0],l=n+2*u[t][1],this._isFree(s,h,l,e,i)){s[h][l]=0,s[o+u[t][0]][n+u[t][1]]=0,o=h,n=l,c=!1,a++;break}}while(!c)}}while(a+1<e*i/4);for(let e=0;e<this._width;e++)for(let i=0;i<this._height;i++)t(e,i,s[e][i]);return this._map=[],this}_randomize(t){for(let e=0;e<4;e++)t[e][0]=0,t[e][1]=0;switch(Math.floor(4*r.a.getUniform())){case 0:t[0][0]=-1,t[1][0]=1,t[2][1]=-1,t[3][1]=1;break;case 1:t[3][0]=-1,t[2][0]=1,t[1][1]=-1,t[0][1]=1;break;case 2:t[2][0]=-1,t[3][0]=1,t[0][1]=-1,t[1][1]=1;break;case 3:t[1][0]=-1,t[0][0]=1,t[3][1]=-1,t[2][1]=1}}_isFree(t,e,i,s,r){return!(e<1||i<1||e>=s||i>=r)&&t[e][i]}},Rogue:class extends I{constructor(t,e,i){super(t,e),this.map=[],this.rooms=[],this.connectedCells=[],(i=Object.assign({cellWidth:3,cellHeight:3},i)).hasOwnProperty("roomWidth")||(i.roomWidth=this._calculateRoomSize(this._width,i.cellWidth)),i.hasOwnProperty("roomHeight")||(i.roomHeight=this._calculateRoomSize(this._height,i.cellHeight)),this._options=i}create(t){if(this.map=this._fillMap(1),this.rooms=[],this.connectedCells=[],this._initRooms(),this._connectRooms(),this._connectUnconnectedRooms(),this._createRandomRoomConnections(),this._createRooms(),this._createCorridors(),t)for(let e=0;e<this._width;e++)for(let i=0;i<this._height;i++)t(e,i,this.map[e][i]);return this}_calculateRoomSize(t,e){let i=Math.floor(t/e*.8),s=Math.floor(t/e*.25);return s<2&&(s=2),i<2&&(i=2),[s,i]}_initRooms(){for(let t=0;t<this._options.cellWidth;t++){this.rooms.push([]);for(let e=0;e<this._options.cellHeight;e++)this.rooms[t].push({x:0,y:0,width:0,height:0,connections:[],cellx:t,celly:e})}}_connectRooms(){let t,e,i,s,o,n,h=r.a.getUniformInt(0,this._options.cellWidth-1),l=r.a.getUniformInt(0,this._options.cellHeight-1),a=!1;do{n=[0,2,4,6],n=r.a.shuffle(n);do{if(a=!1,t=n.pop(),e=h+v[8][t][0],i=l+v[8][t][1],!(e<0||e>=this._options.cellWidth||i<0||i>=this._options.cellHeight)){if((s=this.rooms[h][l]).connections.length>0&&s.connections[0][0]==e&&s.connections[0][1]==i)break;0==(o=this.rooms[e][i]).connections.length&&(o.connections.push([h,l]),this.connectedCells.push([e,i]),h=e,l=i,a=!0)}}while(n.length>0&&0==a)}while(n.length>0)}_connectUnconnectedRooms(){let t,e,i,s=this._options.cellWidth,o=this._options.cellHeight;this.connectedCells=r.a.shuffle(this.connectedCells);for(let n=0;n<this._options.cellWidth;n++)for(let h=0;h<this._options.cellHeight;h++)if(0==(t=this.rooms[n][h]).connections.length){let l=[0,2,4,6];l=r.a.shuffle(l),i=!1;do{let t=l.pop(),r=n+v[8][t][0],a=h+v[8][t][1];if(!(r<0||r>=s||a<0||a>=o)){if(i=!0,0==(e=this.rooms[r][a]).connections.length)break;for(let t=0;t<e.connections.length;t++)if(e.connections[t][0]==n&&e.connections[t][1]==h){i=!1;break}if(i)break}}while(l.length);i?t.connections.push([e.cellx,e.celly]):console.log("-- Unable to connect room.")}}_createRandomRoomConnections(){}_createRooms(){let t,e,i,s,o,n=this._width,h=this._height,l=this._options.cellWidth,a=this._options.cellHeight,c=Math.floor(this._width/l),u=Math.floor(this._height/a),d=this._options.roomWidth,p=this._options.roomHeight;for(let f=0;f<l;f++)for(let l=0;l<a;l++){if(0==(i=c*f)&&(i=1),0==(s=u*l)&&(s=1),t=r.a.getUniformInt(d[0],d[1]),e=r.a.getUniformInt(p[0],p[1]),l>0)for(o=this.rooms[f][l-1];s-(o.y+o.height)<3;)s++;if(f>0)for(o=this.rooms[f-1][l];i-(o.x+o.width)<3;)i++;let a=Math.round(r.a.getUniformInt(0,c-t)/2),g=Math.round(r.a.getUniformInt(0,u-e)/2);for(;i+a+t>=n;)a?a--:t--;for(;s+g+e>=h;)g?g--:e--;i+=a,s+=g,this.rooms[f][l].x=i,this.rooms[f][l].y=s,this.rooms[f][l].width=t,this.rooms[f][l].height=e;for(let r=i;r<i+t;r++)for(let t=s;t<s+e;t++)this.map[r][t]=0}}_getWallPosition(t,e){let i,s,o;return 1==e||3==e?(i=r.a.getUniformInt(t.x+1,t.x+t.width-2),o=1==e?1+(s=t.y-2):(s=t.y+t.height+1)-1,this.map[i][o]=0):(s=r.a.getUniformInt(t.y+1,t.y+t.height-2),o=2==e?(i=t.x+t.width+1)-1:1+(i=t.x-2),this.map[o][s]=0),[i,s]}_drawCorridor(t,e){let i,s,o,n,h=e[0]-t[0],l=e[1]-t[1],a=t[0],c=t[1],u=[],d=Math.abs(h),p=Math.abs(l),f=r.a.getUniform(),g=f,_=1-f;for(s=h>0?2:6,o=l>0?4:0,d<p?(i=Math.ceil(p*g),u.push([o,i]),u.push([s,d]),i=Math.floor(p*_),u.push([o,i])):(i=Math.ceil(d*g),u.push([s,i]),u.push([o,p]),i=Math.floor(d*_),u.push([s,i])),this.map[a][c]=0;u.length>0;)for(n=u.pop();n[1]>0;)a+=v[8][n[0]][0],c+=v[8][n[0]][1],this.map[a][c]=0,n[1]=n[1]-1}_createCorridors(){let t,e,i,s,r,o=this._options.cellWidth,n=this._options.cellHeight;for(let h=0;h<o;h++)for(let o=0;o<n;o++){t=this.rooms[h][o];for(let o=0;o<t.connections.length;o++)e=t.connections[o],(i=this.rooms[e[0]][e[1]]).cellx>t.cellx?(s=2,r=4):i.cellx<t.cellx?(s=4,r=2):i.celly>t.celly?(s=3,r=1):(s=1,r=3),this._drawCorridor(this._getWallPosition(t,s),this._getWallPosition(i,r))}}}};class B{}const j=.5*(Math.sqrt(3)-1),X=(3-Math.sqrt(3))/6;var H={Simplex:class extends B{constructor(t=256){super(),this._gradients=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]];let e=[];for(let i=0;i<t;i++)e.push(i);e=r.a.shuffle(e),this._perms=[],this._indexes=[];for(let i=0;i<2*t;i++)this._perms.push(e[i%t]),this._indexes.push(this._perms[i]%this._gradients.length)}get(t,e){let i,s,r,o=this._perms,n=this._indexes,l=o.length/2,a=0,c=0,u=0,d=(t+e)*j,p=Math.floor(t+d),f=Math.floor(e+d),g=(p+f)*X,_=t-(p-g),m=e-(f-g);_>m?(s=1,r=0):(s=0,r=1);let y=_-s+X,b=m-r+X,w=_-1+2*X,x=m-1+2*X,v=Object(h.mod)(p,l),M=Object(h.mod)(f,l),S=.5-_*_-m*m;if(S>=0){S*=S,i=n[v+o[M]];let t=this._gradients[i];a=S*S*(t[0]*_+t[1]*m)}let C=.5-y*y-b*b;if(C>=0){C*=C,i=n[v+s+o[M+r]];let t=this._gradients[i];c=C*C*(t[0]*y+t[1]*b)}let k=.5-w*w-x*x;if(k>=0){k*=k,i=n[v+1+o[M+1]];let t=this._gradients[i];u=k*k*(t[0]*w+t[1]*x)}return 70*(a+c+u)}}};class Y{constructor(t,e,i,s={}){this._toX=t,this._toY=e,this._passableCallback=i,this._options=Object.assign({topology:8},s),this._dirs=v[this._options.topology],8==this._options.topology&&(this._dirs=[this._dirs[0],this._dirs[2],this._dirs[4],this._dirs[6],this._dirs[1],this._dirs[3],this._dirs[5],this._dirs[7]])}_getNeighbors(t,e){let i=[];for(let s=0;s<this._dirs.length;s++){let r=this._dirs[s],o=t+r[0],n=e+r[1];this._passableCallback(o,n)&&i.push([o,n])}return i}}var q={Dijkstra:class extends Y{constructor(t,e,i,s){super(t,e,i,s),this._computed={},this._todo=[],this._add(t,e,null)}compute(t,e,i){let s=t+","+e;if(s in this._computed||this._compute(t,e),!(s in this._computed))return;let r=this._computed[s];for(;r;)i(r.x,r.y),r=r.prev}_compute(t,e){for(;this._todo.length;){let i=this._todo.shift();if(i.x==t&&i.y==e)return;let s=this._getNeighbors(i.x,i.y);for(let t=0;t<s.length;t++){let e=s[t],r=e[0],o=e[1];r+","+o in this._computed||this._add(r,o,i)}}}_add(t,e,i){let s={x:t,y:e,prev:i};this._computed[t+","+e]=s,this._todo.push(s)}},AStar:class extends Y{constructor(t,e,i,s={}){super(t,e,i,s),this._todo=[],this._done={}}compute(t,e,i){for(this._todo=[],this._done={},this._fromX=t,this._fromY=e,this._add(this._toX,this._toY,null);this._todo.length;){let i=this._todo.shift(),s=i.x+","+i.y;if(s in this._done)continue;if(this._done[s]=i,i.x==t&&i.y==e)break;let r=this._getNeighbors(i.x,i.y);for(let t=0;t<r.length;t++){let e=r[t],s=e[0],o=e[1];s+","+o in this._done||this._add(s,o,i)}}let s=this._done[t+","+e];if(s)for(;s;)i(s.x,s.y),s=s.prev}_add(t,e,i){let s=this._distance(t,e),r={x:t,y:e,prev:i,g:i?i.g+1:0,h:s},o=r.g+r.h;for(let t=0;t<this._todo.length;t++){let e=this._todo[t],i=e.g+e.h;if(o<i||o==i&&s<e.h)return void this._todo.splice(t,0,r)}this._todo.push(r)}_distance(t,e){switch(this._options.topology){case 4:return Math.abs(t-this._fromX)+Math.abs(e-this._fromY);case 6:let i=Math.abs(t-this._fromX),s=Math.abs(e-this._fromY);return s+Math.max(0,(i-s)/2);case 8:return Math.max(Math.abs(t-this._fromX),Math.abs(e-this._fromY))}}}};class G{constructor(t){this._scheduler=t,this._lock=1}start(){return this.unlock()}lock(){return this._lock++,this}unlock(){if(!this._lock)throw new Error("Cannot unlock unlocked engine");for(this._lock--;!this._lock;){let t=this._scheduler.next();if(!t)return this.lock();let e=t.act();e&&e.then&&(this.lock(),e.then(this.unlock.bind(this)))}return this}}var $=i(7);class J{constructor(t,e={}){this._reflectivityCallback=t,this._options={},e=Object.assign({passes:1,emissionThreshold:100,range:10},e),this._lights={},this._reflectivityCache={},this._fovCache={},this.setOptions(e)}setOptions(t){return Object.assign(this._options,t),t&&t.range&&this.reset(),this}setFOV(t){return this._fov=t,this._fovCache={},this}setLight(t,e,i){let s=t+","+e;return i?this._lights[s]="string"==typeof i?$.fromString(i):i:delete this._lights[s],this}clearLights(){this._lights={}}reset(){return this._reflectivityCache={},this._fovCache={},this}compute(t){let e={},i={},s={};for(let t in this._lights){let e=this._lights[t];i[t]=[0,0,0],$.add_(i[t],e)}for(let t=0;t<this._options.passes;t++)this._emitLight(i,s,e),t+1!=this._options.passes&&(i=this._computeEmitters(s,e));for(let e in s){let i=e.split(",");t(parseInt(i[0]),parseInt(i[1]),s[e])}return this}_emitLight(t,e,i){for(let s in t){let r=s.split(","),o=parseInt(r[0]),n=parseInt(r[1]);this._emitLightFromCell(o,n,t[s],e),i[s]=1}return this}_computeEmitters(t,e){let i={};for(let s in t){if(s in e)continue;let r,o=t[s];if(s in this._reflectivityCache)r=this._reflectivityCache[s];else{let t=s.split(","),e=parseInt(t[0]),i=parseInt(t[1]);r=this._reflectivityCallback(e,i),this._reflectivityCache[s]=r}if(0==r)continue;let n=[0,0,0],h=0;for(let t=0;t<3;t++){let e=Math.round(o[t]*r);n[t]=e,h+=e}h>this._options.emissionThreshold&&(i[s]=n)}return i}_emitLightFromCell(t,e,i,s){let r,o=t+","+e;r=o in this._fovCache?this._fovCache[o]:this._updateFOV(t,e);for(let t in r){let e,o=r[t];t in s?e=s[t]:(e=[0,0,0],s[t]=e);for(let t=0;t<3;t++)e[t]+=Math.round(i[t]*o)}return this}_updateFOV(t,e){let i=t+","+e,s={};this._fovCache[i]=s;let r=this._options.range;return this._fov.compute(t,e,r,function(t,e,i,o){let n=o*(1-i/r);0!=n&&(s[t+","+e]=n)}.bind(this)),s}}i.d(e,"Util",function(){return Q}),i.d(e,"Color",function(){return Z}),i.d(e,"Text",function(){return tt}),i.d(e,"RNG",function(){return r.a}),i.d(e,"Display",function(){return k}),i.d(e,"StringGenerator",function(){return P}),i.d(e,"EventQueue",function(){return T}),i.d(e,"Scheduler",function(){return F}),i.d(e,"FOV",function(){return A}),i.d(e,"Map",function(){return W}),i.d(e,"Noise",function(){return H}),i.d(e,"Path",function(){return q}),i.d(e,"Engine",function(){return G}),i.d(e,"Lighting",function(){return J}),i.d(e,"DEFAULT_WIDTH",function(){return w}),i.d(e,"DEFAULT_HEIGHT",function(){return x}),i.d(e,"DIRS",function(){return v}),i.d(e,"KEYS",function(){return M});const Q=h,Z=$,tt=s}]);